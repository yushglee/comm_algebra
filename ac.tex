\documentclass[leqno]{amsart}
\usepackage{amssymb}
\usepackage{amsmath} 
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{mathrsfs}
\usepackage{color,stmaryrd}
\usepackage{mathtools,caption,euscript}
\usepackage[table,dvipsnames]{xcolor}
\usepackage{tikz-cd}
\usepackage[utf8]{inputenc}
\usepackage[OT2,T1]{fontenc}
\hypersetup{
 colorlinks=true,
 linkcolor=DarkOrchid,
 filecolor=blue,
 citecolor=olive,
 urlcolor=orange,
 pdftitle={Commutative Algebra},
 %pdfpagemode=FullScreen,
 }
\usepackage{booktabs}

%[label=(\alph*)]
%[label=(\Alph*)]
%[label=(\roman*)]
%[label={(\bfseries R\arabic*)}]

\makeatletter
\newcommand\myprimeitem{%
 \item[(\roman{enumi}\textquotesingle)]\def\@currentlabel{(\roman{enumi}\textquotesingle)}}
\makeatother


\setlength{\textwidth}{\paperwidth}
\addtolength{\textwidth}{-2in}
\calclayout



\newcommand{\smat}[1]{\left( \begin{smallmatrix} #1 \end{smallmatrix} \right)}
\newcommand{\mat}[1]{\left( \begin{smallmatrix} #1 \end{smallmatrix} \right)}
\newcommand{\dBr}[1]{\llbracket{#1}\rrbracket}
\newcommand{\leg}[2]{\left(\frac{#1}{#2}\right)}

% double bracket
\makeatletter
\newsavebox{\@brx}
\newcommand{\llangle}[1][]{\savebox{\@brx}{\(\m@th{#1\langle}\)}%
  \mathopen{\copy\@brx\kern-0.5\wd\@brx\usebox{\@brx}}}
\newcommand{\rrangle}[1][]{\savebox{\@brx}{\(\m@th{#1\rangle}\)}%
  \mathclose{\copy\@brx\kern-0.5\wd\@brx\usebox{\@brx}}}
\makeatother

\newcommand{\qdr}[1]{\underline{ #1 }}
\newcommand{\cA}{\mathcal A} %complex abelian varieties
\newcommand{\cB}{\mathcal B} %complex abelian varieties
\newcommand{\bB}{\mathbf B}

\newcommand{\mm}{\mathbf{m}}


%%% Adelic rings
\newcommand{\Q}{{\mathbf{Q}}}
\newcommand{\Z}{{\mathbf{Z}}}
\newcommand{\Qp}{\mathbf{Q}_p}
\newcommand{\Zp}{\mathbf{Z}_p}
\newcommand{\Ql}{\mathbf{Q}_\ell}
\newcommand{\Zl}{\mathbf{Z}_\ell}
\newcommand{\R}{\mathbf R}
\newcommand{\C}{\mathbf C}
\newcommand{\A}{\mathbf A}
\newcommand{\hZ}{{\hat{\mathbf{Z}}}}
\newcommand{\dd}{\mathfrak{d}} %different
\newcommand{\DD}{\mathcal{D}}  %discriminant

\newcommand{\F}{{\mathcal{F}}} %global 
\newcommand{\OF}{{\mathcal{O}_{\F}}}
\newcommand{\K}{{\mathcal{K}}} %global quadratic
\newcommand{\OK}{\mathcal{O}_{\K}}
\newcommand{\kk}{F} %local
\newcommand{\E}{E} %local quadratic


\DeclareMathOperator{\Sel}{Sel}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Nr}{\mathsf{N}}
\DeclareMathOperator{\Tr}{Tr}



\DeclareMathOperator{\gr}{gr}
\DeclareMathOperator{\hht}{ht}
\DeclareMathOperator{\rad}{rad}
\DeclareMathOperator{\Supp}{Supp}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Ass}{Ass}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Der}{Der}
\DeclareMathOperator{\trdeg}{tr.deg}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\prd}{proj.dim}
\DeclareMathOperator{\gld}{gl.dim}

%%% Fonts
\newcommand{\oeu}{\EuScript{O}}
\newcommand{\eeu}{\EuScript{E}}
\newcommand{\feu}{\EuScript{F}}
\newcommand{\geu}{\EuScript{G}}
\newcommand{\keu}{\EuScript{K}}

\newcommand{\oo}{\mathcal O}
\newcommand{\bs}{\mathcal S}
\newcommand{\id}{\mathbf{1}}

\newcommand{\1}{\mathbf{1}} 
\newcommand{\bfe}{\mathbf e}
\newcommand{\bff}{\mathbf f}

\newcommand{\bX}{\mathbb{X}}
\newcommand{\bY}{\mathbb{Y}}
\newcommand{\bV}{\mathbb{V}}
\newcommand{\bW}{\mathbb{W}}

\newcommand{\fa}{\mathfrak a}
\newcommand{\fg}{\mathfrak g}
\newcommand{\fc}{\mathfrak c}
\newcommand{\fs}{\mathfrak s}
\newcommand{\fm}{\mathfrak m}
\newcommand{\fn}{\mathfrak n}
\newcommand{\fl}{\mathfrak l}
\newcommand{\fp}{\mathfrak p}
\newcommand{\bfp}{\overline{\mathfrak p}}
\newcommand{\fq}{\mathfrak q}
\newcommand{\bfq}{\overline{\mathfrak q}}

\newcommand{\btheta}{\boldsymbol{\theta}}
\newcommand{\bdelta}{\boldsymbol{\delta}}


\newcommand{\fG}{\mathfrak{G}}
\newcommand{\fX}{\mathfrak{X}}
\newcommand{\euW}{\EuScript{W}}


%%% Categorical
\DeclareMathOperator{\Ext}{Ext}
\DeclareMathOperator{\Tor}{Tor}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Inj}{Inj}
\DeclareMathOperator{\Isom}{Isom}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\corank}{corank}


\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\rec}{rec}





\newtheorem*{theorem*}{Theorem}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}


\theoremstyle{definition}
\newtheorem{definition}[thm]{Definition}
\newtheorem{defn}[thm]{Definition}
\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem*{Remark*}{Remark}
\newtheorem{ack}{Acknowledgement}

\newcommand{\red}[1]{\textcolor{Red}{#1}}



\begin{document}
\title{Commutative Algebra}
\author[Y-S.~Lee]{Yu-Sheng Lee}
\address{Department of Mathematics, University  of Michigan, Ann Arbor, MI 48109, USA}
\email{yushglee@umich.edu}
\date{\today}

\maketitle
\setcounter{tocdepth}{1}
\tableofcontents


\section{Completion}
\subsection{Completion}
\begin{defn}
	Let $A$ be a ring,
	$(A_n)$ be a decreasing filtration of ideals of $A$ satisfying
	\[
		A_{0}=A,\quad
		A_{n+1}\subset A_{n},\quad
		A_{n}A_{m}\subset A_{n+m}.
	\]
	Let $M$ be an $A$-module, 
	$(M_n)$ be a compatible decreasing filtration of submodules of $M$ satisfying
	\[
		M_{0}=M,\quad
		M_{n+1}\subset M_{n},\quad
		A_{n}M_{m}\subset M_{n+m}.
	\]
	When $\fq\subset A$ is an ideal, 
	the $\fq$-adic filtration is defined by $A_n=\fq^nA, M_n=\fq^nM$.
\end{defn}
\begin{defn}
	A ring $A$ is said to be graded if
	\[
		A=\oplus_{n\geq 0} A_n \text{ and } A_nA_m\subset A_{n+m}.
	\]
	An $A$-module $M$ is said to be compatibly graded if
	\[
		M=\oplus_{n\geq 0} M_n \text{ and } A_nM_m\subset M_{n+m}.
	\]
Given a filtered ring $A$ and 
a compatibly filtered $A$-module $M$, 
we can define the associated graded ring $\gr(A)$
and the associated compatibly graded $\gr(A)$-module $\gr(M)$
 \[
	 \gr(A)=\oplus_{n\geq 0}A_n/A_{n+1},\quad
	 \gr(M)=\oplus_{n\geq 0}M_n/M_{n+1}.
\]
\end{defn}
Let $A$ be a Noetherian ring
and $\fq\subset A$ be an ideal.
Consider the following property on $(M_n)$.
\begin{align*}\tag{$\fq$-good}
	&\text{there exists a positive $n_{0}$ such that }
	M_{n+k}=\fq^kM_{n} \text{ for all }
	n\geq n_0 \text{ and } k\geq 0\\
	\Longleftrightarrow
	&\gr(M) \text{ is finite over the Noetherian ring } \gr(A).
\end{align*}
\begin{prop}[Artin-Rees]
	Let $A$ be a Noetherian ring,
	$M$ be an $A$-module,
	$(M_n)$ be a $\fq$-good filtration,
	$N\subset M$ be a submodule,
	then the induced filtration $N_n\coloneqq M_n\cap N$
	is also  $\fq$-good.
\end{prop}
\begin{prop}[Krull intersection]
	Let $A$ be a Noetherian ring,
	$M$ be a finite $A$-module,
	then
	\[
		x\in \bigcap_{n\geq 0} \fq^nM
		\Longleftrightarrow
		\text{ there exists }
		d\in \fq \text{ such that }
		dx=x.
	\]
\end{prop}
\begin{proof}
The submodule $N\coloneqq \cap_n \fq^nM$ satisfies $\fq N=N$ 
by the Artin-Rees lemma. 
Pick any generating set $\{ x_1\cdots x_n \}$,
there exists $A=(a_{ij}), a_{ij}\in \fq$ such that 
$x_j=\sum a_{ij}x_i$,
then we can pick $1-d=\det(\id_{n}-A)$.
\end{proof}
\begin{rem}
	When $A$ is a local ring and $M$ is finite,
	$M\to \hat{M}$ is injective by the above.
\end{rem}
Note that $ \hat{\fq}\subset \rad(\hat{A})$ 
since $1+\fq\subset \hat{A}^\times$.
Moreover, when $A$ is Noetherian, the followings hold.
\begin{enumerate}[label=(\alph*)]
	\item 
	The $\fq$-adic filtration is exact on finite $A$-modules.
	%Given $0\to M'\to M\to M''\to 0$ consider
	%\[
	%	0\to M'/(M\cap \fq^nM)
	%	\to M/\fq^nM
	%	\to M''/\fq^nM''\to 0
	%\]
	%and use that $\hat{M}'\cong \varprojlim M'/(M\cap \fq^nM)$ 
	%by the Artin-Rees lemma.
	\item 
	Let $M$ be a finite $A$-module,
	then $M\otimes_A\hat{ A }\to \hat{ M }$ is an isomorphism.
	%\[
	%	\begin{tikzcd}
	%	A^m\otimes_A\hat{ A }
	%	\arrow[r]
	%	\arrow[d] &
	%	A^n\otimes_A\hat{ A }
	%	\arrow[r]
	%	\arrow[d] &
	%	M\otimes_A\hat{ A }
	%	\arrow[r]
	%	\arrow[d] & 0\\
	%	\hat{ A }^m
	%	\arrow[r] &
	%	\hat{ A }^n
	%	\arrow[r] &
	%	\hat{ M }
	%	\arrow[r] & 0.
	%	\end{tikzcd}
	%\]
	\item 
	Let $I\subset A$ be an ideal and 
	$M$ be a finite $A$-module,
	then $I\hat{M}=\hat{IM}=\hat{I}\hat{M}$.
	%\[
	%	\begin{tikzcd}
	%	I\otimes_AM\otimes_A\hat{A}
	%	\arrow[r,"u"] \arrow[d] \arrow[dr,"v"] & 
	%	I\otimes_A\hat{M}
	%	\arrow[d]\\
	%	IM\otimes_A\hat{A}
	%	\arrow[r,"w"] & \hat{M}
	%	\end{tikzcd}	
	%\]
	In particular $\hat{A}$ is flat over $A$
	since $I\otimes\hat{A}\cong \hat{I}\cong I\hat{A}$ 
	for any finitely generated ideal $I$.
	\item  
	$M/\fq^nM=\hat{M}/\fq^n\hat{M}=\hat{M}/\hat{\fq}^n\hat{M}$.
	\item 
	Let $A$ be a local ring, then
	the completion $\hat{A}$ 
	at the maximal ideal is faithfully-flat over $A$.
	%Since taking the $\fq$-adic completions is exact,
	%the above shows that  $M\to M\otimes\hat{A}$ is 
	%exact on finite $A$-modules.
	%Since to check the injectivity of 
	%$M'\otimes\hat{A}\to M\otimes\hat{A}$
	%if suffices to check on finite submodules,
	%we see that $\hat{A}$ is flat.
	%And $\hat{A}$ is faithful since 
	%for any ideal $I$ there exists the surjection 
	%$A/I\to A/\fm$ and
	%$A/\fm\otimes\hat{A}\cong \hat{A}/\hat{\fm}$.
\end{enumerate}
\begin{prop}
	Suppose $A/\fq$ is Noetherian and $\fq$ is finitely-generated,
	then $\hat{A}$ is Noetherian.
\end{prop}
\begin{proof}
	Use that $\gr^{\fq}(A)$ is Noetherian.
	Let $I$ be an ideal of $ \hat{A}$,
	then $\gr^{\fq}(I)$ is finitely generated, 
	pick any generating set and lift which to an homomorphism
	between $\fq$-adically filtered $ \hat{A}$-modules
	 \[
		u\colon \hat{A}^{s}\to I
		\text{ such that } \gr(u) \text{ is surjective.}
	\]
	Then $u$ is also surjective since  $ \hat{A}$ is complete
	and $I\subset \hat{A}$ is separated.
\end{proof}

\subsection{Support of a sheaf}
\begin{defn}
	Let $X$ be a ringed space and 
	$F$ be an $\mathcal{O}_{X}$-module,
	the set of points $x\in X$ such that $F_x\neq 0$
	is called the support of $F$ and is denoted  $\Supp(F)$.
\end{defn}
\begin{enumerate}[label=(\alph*)]
	\item 
	Given an exact sequence $0\to F'\to F\to F''\to 0$
	of $A$-modules, then
	\[
		\Supp(F)=\Supp(F')\cup \Supp(F'').
	\]
	\item
	Let $M,M'$ be  $A$-modules of finite type, then
	both $\Supp(M)$ and $\Supp(M')$ are closed and
	\[
		\Supp(M\otimes_AM')=\Supp(M)\cap \Supp(M').
	\]
	%After localization at a common support, 
	%the Nakayama lemma ensures that 
	%$M/\fm M$ and $M'/\fm M'$ are both nonzero, then so does
	%$M\otimes_AM'$ since
	%$M/\fm M\otimes_{A/\fm}M'/\fm M'=
	%(M\otimes_AM')\otimes_AA/\fm$.
	\item
	Let $M$ be a $A$-module of finite type and 
	$J$ be the annihilator, then  $\Supp(M)=V(J)$.
	%Use the finiteness and $\Supp(A/I)=V(I)$.
	\item
	Let $M$ be a $A$-module of finite type and $I$ be an ideal,
	then $\Supp(M/IM)=\Supp(M)\cap V(I)$.
	\item
	Let $f\colon X\to Y$ be a morphism of schemes
	and  $F$ be an $\mathcal{O}_X$-module of finite type, then
	\[\Supp(f^*F)=f^{-1}(\Supp(F)).\]
\end{enumerate}
\begin{prop}[Weak Nullstellensatz]
	Let $M$ be a finite $A$-module and $f\in A$.
	Then $f\colon M\to M$ is a nilpotent if and only if 
	$f$ lies in every prime of $\Supp(M)$.
\end{prop}
\begin{proof}
	The map is a nilpotent if and only if $M_f=0$,
	use $\Supp(M_f)=\Supp(M)\cap D(f)$.
\end{proof}

\subsection{Associated primes}
\begin{defn}
	A prime ideal $\fp$ is an associated prime
	for an $A$-module $M$ 
	if it is the annihilator of some  $x\in M$.
	If  $X$ is a scheme and $F$ is an $\mathcal{O}_X$-module,
	then  $\Ass(F)=\{x\in X\mid \fm_x\in \Ass(F_x)\}$.
\end{defn}
\begin{enumerate}[label=(\alph*)]
	\item 
	Given $0\to M'\to M\to M''\to 0$, then 
	$\Ass(M)\subset \Ass(M')\cup \Ass(M'')$.
	%given an inclusion $A/\fp\hookrightarrow m$,
	%either there exists a nonzero $x\in A/\fp\cap M'$
	%so that $\fp=\ann(x)\in \Ass(M')$, 
	%or $A/\fp\hookrightarrow M''$.
	\item
	When $A$ is Noetherian, an $A$-module $M$ is nonzero
	if and only if $\Ass(M)=\emptyset$.
	\item
	When $A$ is Noetherian, the set of zero divisors of $M$ is 
	the union of the associated primes of $M$.
	\item
	When $A$ is Noetherian and  $M$ is a finite $A$-fmodule,
	there exists a filtration
	\[
		M=M_{0}\supset \cdots\supset M_{n}=0
		\text{ such that } M_i/M_{i+1}\cong A/\fp_i.
	\]
	Therefore $\Ass(M)\subset\{\fp_1,\cdots,\fp_n\}$ is finite.
	\item
	When $A$ is Noetherian,
	$\Ass_{S^{-1}A}(S^{-1}M)=
	\{p\in \Ass_A(M)\mid \fp\cap S=\emptyset\}$.
	%Need finite generation to show 
	%$S^{-1}\fp\in \Ass(S^{-1}M)\Longrightarrow \fp\in \Ass(M)$.
	\item
	When $A$ is Noetherian,
	$\Supp(M)=\cup_{\fp\in \Ass(M)}V(\fp)$.
	%If $M_{\fp}\neq 0$, by above there exists $\fq\in \Ass(M)$
	%such that $\fq\cap A\setminus \fp=\emptyset$.
\end{enumerate}

\subsection{Characteristic functions}
\begin{defn}
	A composition series of an $A$-module $M$ is a filtration
	\[
		M=M_0\supset \cdots \supset M_n=0
		\text{ such that } M_i/M_{i+1} \text{ are simple.}
	\]
	Define $\ell_A(M)=n$, then
	$\ell(M)=\ell(M')+\ell(M'')$ given
	$0\to M'\to M\to M''\to 0$.
	When $A$ is Noetherian, $M$ is of finite length
	if and only if $\Supp(M)$ consists only of maximal ideals.
\end{defn}
\begin{prop}
	A ring $A$ is Artinian if and only if 
	$A$ is Noetherian and every prime ideal is maximal.
\end{prop}
\begin{proof}
	If $A$ is Noetherian, by Noetherian induction 
	every ideal contains a finite product of primes.
	%Otherwise, let $I$ be a maximal one that doesn't satisfy
	%the property. Then $I$ is necessarily not a prime ideal
	%and there exists $x,y\notin I, xy\in I$.
	%One then use $(I+Ax)(I+Ay)\subset I$ to get a contradiction.
	Therefore $0=\fm_1\cdots \fm_n$ and one obtain
	a composition series from which.
	%Note that on defining $I_i=m_1\cdots m_i$, 
	%each $I_i/I_{i+1}$ is a vector space over $A/m_{i+1}$
	%of finite dimension by the Noetherian property.

	If $A$ is Artinian,
	among finite product of maximal ideals of $A$ 
	pick a minimal $\fm$, so
	\[
		\fm^2=\fm \text{ and } \fm\subset \rad(A).
	\]
	If $\fm\neq 0$, 
	among ideals such that $I\fm\neq 0$ 
	pick a minimal  $I$.
	Then for $x\in I$, either
	\begin{enumerate}
		\item $I\nsupseteq Ax$ and hence $x\fm=0$, or 
		\item  $I=Ax$, but then $I=0$ by Nakayama lemma
			since $I\fm=I$ from the minimality of $I$.
	\end{enumerate}
	Therefore $\fm=0$, and consequently
	$A$ is of finite length and every prime ideal
	of $A$ is maximal.
\end{proof}
Let $\fm_1\cdots \fm_n$ be the maximal ideal of an Artinian ring $A$,
then 
\begin{enumerate}[label=(\alph*)]
	\item $A\cong \prod_{i=1}^{n}A_{\fm_i}$.
	%Pick any $f\in \prod_{j\neq i}\fm_j\setminus \fm_i$, 
	%then $D(f)=\{\fm_i\}$.
	\item $A_{\fm_i}\to A/\fm_i^{k}$ is an isomorphism when
		$k$ is sufficiently large.
\end{enumerate}

\begin{lem}
	Let $H$ be a graded ring and 
	$M$ be a graded $H$-module of finite type.
	If $H$ satisfies 
	\begin{enumerate}[label=(\alph*)]
		\item $H_0$ is Artinian,
		\item $H$ is an $H_0$-algebra generated by 
			$x_1\cdots x_r\in H_1$.
	\end{enumerate}
	Then there exists a polynomial $Q_M$ of degree
	$\leq r-1$ such that $Q_M(n)=\ell_{H_0}(M_n)$ for  $n\gg0$.
\end{lem}
\begin{proof}
	In general, let $k_i$ be the degree of $x_i$,
	then the Poincare series  
	$P(x)=\sum_{n=0}^\infty \ell_{H_0}(M_n)x^n$ is of the form
	\[
		P(x)=\frac{f(x)}{\prod_{i=1}^{r}(1-x^{k_i})},\quad
		f(x) \text{ is polynomial.}
	\]	
	%Inductively consider the exact sequence 
	%$0\to K_n\to M_n\xrightarrow{x_r} M_{n+k_{s}}
	%\to L_{n+k_s}\to 0$.
	Thus $\ell(M_n)$, i.e. the coefficients of $x^n$
	in  $P(x)$, is a polynomial of degree at most $r-1$
	in the case when $k_i=1$ for all  $i$ since
	\[
		(1-x)^{-r}=\sum_{n\geq 0}\binom{n+r-1}{r-1}t^n.
	\]
\end{proof}

\begin{prop}\label{prop:Hilbert-Samuel}
	Let $A$ be a Noetherian ring 
	and $M$ be a finite $A$-module.
	Given a $q$-good filtration $(M_n)$,
	then when $M/qM$ has finite lengh,
	\begin{enumerate}[label=(\alph*)]
	\item 
	there exists a polynomial  $P_{(M_n)}$
	of degree $\leq r$
	such that $P_{(M_n)}(m)=\ell(M/M_m)$ for $m\gg0$.
	\item 
	The degree and leading coefficient of $P_{(M_n)}$
	are independent of the choice of filtration.
	\item 
	Given $0\to M'\to M\to M''\to 0$, then
	 $P_{(M_n)}-P_{(M'_n)}-P_{(M''_n)}$ has degree $\leq r-1$.
	\end{enumerate}
\end{prop}
\begin{proof}
	Let $I=\Ann(M), B=A/I$ and $\fp=\fq+I/I$.
	Then $H=\gr^{\fp}(B)$ acting on $\gr(M)$ satisfies
	the assumptions of the previous lemma
	since $\Supp(M/\fq M)=V(I) \cap V(\fq)$
	consists only of maximal primes. 
	One then use 
	\[
		(1-x)\sum_{n=1}^\infty \ell(M/M_n)x^n
		=\sum_{n=0}^\infty \ell(M_n/M_{n+1})x^n.
	\]
	Since $(M_n)$ is $\fq$-good, there exists $n_0$ such that 
	$M_{n+1}=\fq M_n$ for $n\geq n_{0}$. Thus when $n\gg 0$
	 \[
		\fq^{n+n_0}M\subset M_{n+n_0}=\fq^nM_{n_0}\subset M_n
		\Longrightarrow
		P_{(\fq^mM)}(n+n_0)\geq P_{(M_m)}(n+n_0)\geq 
		P_{(\fq^mM)}(n)\geq P_{(M_m)}(n),
	\]
	therefore the degree and leading coefficient
	do not depends on $(M_n)$.

	The last property then follows from the previous two 
	and that
	\[
		 \ell(M/\fq^nM)=\ell(M''/\fq^nM'')+\ell(M'/M'_n),\quad
		 M'_n\coloneqq M'\cap \fq^nM.
	\]
\end{proof}
\section{Depth and Dimension}

Let $A$ be a Noetherian local ring with maximal ideal $m$
and  $M$ be a finite $A$-module. Define
\begin{enumerate}[label=(\alph*)]
	\item 
		$\dim (M)\coloneqq \dim (\Supp(M))$.
	\item 
		$d(M)\coloneqq \deg(P_{\fq^nM})$ for an ideal of definition
		$\fm^n\subset \fq\subset \fm$.
	\item 
		$s(M)$ is the minimal number 
		$\{x_1,\cdots ,x_n\}\subset \fm$ such that 
		$M/(x_1,\cdots,x_n)M$ is of finite length.
\end{enumerate}


\begin{thm}
	The three values are equal to each other.
\end{thm}	
\begin{proof}
	To prove $\dim(M)\leq d(M)$,
	pick  $\fp\in \Ass(M)$ such that  $\dim(M)=\dim(A/\fp)$
	and reduce to show
	 \[
		 \dim(M)=\dim(A/\fp)\leq d(A/\fp)\leq d(M).
	\]
	If $d(A/\fp)=0$, then $A/\fp$ is of finite length and Artinian.
	If $d(A/\fp)>0$, there is nothing to prove when $\dim(A/\fp)=0$
	. And when there exists
	 \[
		 \fp=\fp_0\subset \fp_1\subset \cdots\subset \fp_n,\quad n=\dim(A/\fp),
	\]
	pick $x\in \fp_1\setminus \fp_0$, then  $\dim(A/(\fp,x))\geq n-1$ while  $d(A/(\fp,x))\leq d(A)-1$
	since $0\to A/\fp\xrightarrow{x} A/\fp\to A/(\fp,x)\to 0$ is exact, thus by induction on $d(M)$ 
	 \[
		 \dim(A/\fp)-1\leq \dim(A/(\fp,x))\leq d(A/(\fp,x))\leq d(A/\fp)-1
		 \Longrightarrow
		 \dim(A/\fp)\leq d(A/\fp).
	\]

	That $d(M)\leq s(M)$ follows from the proof of 
	Proposition \ref{prop:Hilbert-Samuel}.

	To prove that  $s(M)\leq \dim(M)$.
	Observe that  $M$ is of finite length when $\dim(M)=0$. 
	If $\dim(M)\geq 0$, let  $\{\fp_1,\cdots,\fp_h\}$ be the set of
	associated primes such that $\dim(M)=\dim(A/\fp_i)$,
	then none of $\fp_i$ are maximal and there exists  
	$x\in \fm\setminus \cup_i \fp_i$.
	%Since $m\nsubseteq \fp_i$, inductively there exists  $x_i\in \fm\setminus \cup_{j\neq i}\fp_i$,
	%then  $x_h+\prod_{i\neq h}x_i\in \fm\setminus \cup_i \fp_i$.
	For which $s(M/xM)+1\geq s(M)$ and $\dim(M/xM)\leq \dim(M)-1$, 
	thus by induction on  $\dim(M)$
	 \[
		 s(M)\leq s(M/xM)+1\leq \dim(M/xM)+1\leq \dim(M). 
	\]
\end{proof}
\begin{enumerate}
	\item   
	$\dim(M/xM)\geq \dim(M)-1$ for  $x\in \fm$.
	The equality holds when $x$ doesn not belong 
	to any $\fp\in \Supp(M)$ such that $\dim(M)=\dim(A/\fp)$.
	In particular when $x$ is not a zero-divisor.
	\item
	$\dim_A(M)=\dim_{\hat{A}}(\hat{M})$.
	\item
	a prime ideal $\fp$ has height  $\leq n$
	if and only there exists an ideal  $I$
	generated by  $n$ elements such that 
	$\fp$ is a minimal ideal of  $A/I$ 
	%$A_p/I$ is Artinian
	(Krull's principal ideal theorem when $n=1$).
\end{enumerate}

\begin{thm}[Noether normalization lemma]
	Let $k$ be a field, $A$ be a finite type $k$-algebra, 
	and $I_1\subset\cdots\subset I_r$ be 
	a sequence of proper ideals for $A$.
	Then there exists algebraically independent 
	${y_1,\cdots,y_n}$ such that
	\begin{enumerate}[label=(\alph*)]
		 \item $A$ is integral over $B=k[y_1,\cdots,y_n]$.
		 \item For each $1\leq i\leq r$,
			 there exists $h(i)\geq 0$ such that 
			 $I_i\cap B$ is generated by
			  $\{ y_1, \cdots,y_{h(i)}\}$.
	\item 
	when $A$ is a domain and 
	$\fp_0\subset \cdots\subset \fp_n$ 
	is a maximal chain of prime ideals, $n=\trdeg_k A$.
	\item
	if $\fm$ is a maximal ideal, 
	then $A/\fm$ is algebraic over $k$
	(Nullstellensatz).
	\end{enumerate}
\end{thm}

Let $A=k[x_1,\cdots,x_n]$.
If $\{x_1,\cdots,x_r\}$ is an alg.independent set in 
$frac(A/\fp)$, then 
$\fp\cap k[x_1,\cdots,x_r]=0$.
If furthermore it's a transcendental basis, 
let $S=k[x_1,\cdots,x_r]\setminus 0$, then
$A_S/\fp A_S$ is a finite field extension over $k(x_1,\cdots,x_r)$.
\begin{enumerate}[label=(\alph*)]
	\item If $\fp\subset \fq$, then 
		$\trdeg_k(A/\fp)>\trdeg_k(A/\fq)$.
	\item If $\fp\subset \fq$ and
		$\trdeg_k(A/\fp)\geq \trdeg_k(A/\fq)+2$,
		suppose
		\begin{gather*}
			\{x_1,\cdots,x_r\} 
			\text{ is a transcendental basis in }
			A/\fq, S=k[x_1,\cdots,x_r]\setminus0\\
			\{x_1,\cdots,x_r,x_{r+1}\} 
			\text{ is alg.independent in }
			A/\fp, S'=k[x_1,\cdots,x_{r+1}]\setminus0\\
		\end{gather*}
		then $\fp A_{S'}\subset A_{S'}$ is not maximal
		and $\fm\cap A_S$ is not maximal for any
		$\fm\subset A_{S'}$. 
		Thus there exists $\fp\subset \fp'\subset\fq$.
\end{enumerate}
We conclude that $\trdeg_k(A/\fp)=\dim(A/\fp)=n-\hht(\fp)=\dim(A)-\hht(\fp)$.

\subsection{Depth}
Assume throughout the subsection that $A$ is a Noetherian ring.
\begin{defn}
Let $M$ be an  $A$-module, 
a sequence $(x_1,\cdots,x_r)$ of elements in $a$ is $M$-regular if
\[
	0\to M_{i-1}\xrightarrow{x_i} M_{i-1},\quad
	M_{i-1}\coloneqq M/(x_1,\cdots,x_{i-1})M \text{ for all }
	1\leq i<r.
\]
It is $M$-quasi-regular if the canonical surjection
\[
	\varphi_r\colon (M/JM)[T_1,\cdots,T_r]\to \gr_J(M),\quad
	J=(x_1,\cdots,x_r)
\]
is an isomorphism.
When $x_1,\cdots,x_{r}\in \rad(A)$,
the sequence is $M$-regular
if and only if it is $M$-quasi-regular.
Let $I$ be an ideal,
define $\depth_I(M)$ to be the maximal length
of $M$-regular sequence in $I$.
\end{defn}
\begin{lem}
	If $(x_1,\cdots,x_r)$ is a regular sequence, 
	then $\hht(x_1,\cdots,x_r)=r$.
\end{lem}
\begin{proof}
	When $r=1$ and $\fp$ is a minimal prime 
	containing  $(x_1)$, then
	$\hht(\fp)\leq 1$ by Krull's principal ideal theorem.
	Since  $\fp$ contains a non-zero-divisor $x_1$,
	the equality hodls.

	When  $r>1$, let  $A'=A/(x_1)$ and $\fp'=\fp'/(x_1)$.
	By induction on $r$,
	$\hht(\fp')=r-1$.
	Pick  $\fp'_{r-1}\supset \cdots\supset \fp'_0=\fp'$,
	which pulls back to 
	$\fp_{r-1}\supset \cdots\supset \fp_0=\fp$,
	then $\fp_{r-1}$ is a minimal prime containing $(x_1)$
	and hence  $\hht(\fp_{r-1})=1$,
	therefore $\hht(\fp)=r$.
\end{proof}


\begin{prop}
	Let $A$ be a Noetherian ring and $M$ be a finite $A$-module, the following are equivalent.
	\begin{enumerate}
	\item 
	$\Ext^q(N,M)=0$ for all $q<r$ and all 
	finite $A$-modules $N$ such that $\Supp(N)\subset V(I)$.
	\item 
	$\Ext^q(N,M)=0$ for all $q<r$ and some 
	finite $A$-modules $N$ such that $\Supp(N)=V(I)$.
	\item 
	Given $x_1,\cdots,x_n\in I$ such that
	$(x_1,\cdots,x_n)$ is $M$-regular,
	there exists $x_{n+1},\cdots,x_r\in I$ such that 
	$(x_1,\cdots,x_r)$ is $M$-regular.
	\item 
	There exists an $M$-regular sequence $x_1,\cdots,x_r\in I$.
	\end{enumerate}
	In particular
	$\depth(A)=\depth(\hat{A})$
	since $\hat{A}$ is faithfully-flat over $A$
	and $\Ext^i(A/\fm, M)\otimes_A\hat{A}\cong
	\Ext^1(\hat{A}/\hat{\fm}, \hat{M})$.
\end{prop}
\begin{proof}
	If $\Hom(N,M)=0$ and $\Supp(N)=V(I)$,
	then $I\nsubseteq \fp$ for any  $\fp\in \Ass(M)$.
	Otherwise there exists a nonzero
	$N\to A/\fp\hookrightarrow M\neq 0$.
	%If $\fp\in \Supp(N)$, then the  $A/\fp$
	%vector space  $N/\fpN$ is nonzero 
	%since  $N_{\fp}/\fp N_{\fp}\neq 0$ be the Nakayama lemma.
	Hence there exists $x_0\in I\setminus \cup_{\fp\in\Ass(M)}\fp$,
	and therefore $M$-regular.
	Use the argument inductively on 
	$M_n=M/(x_1,\cdots,x_n)M$ 
	to show $(ii)\Longrightarrow(iii)$.

	On the other hand, if $x_0$ is  $M$-regular then
	\[
		0\to \Hom(N,M)\xrightarrow{x_0}\Hom(N,M).
	\]
	But $x_0\in I$ is a nilpotent on N 
	if $\Supp(N)\subset V(I)$, and hence $\Hom(N,M)=0$.
	Use the argument inductively on $r$
	to show  $(iv)\Longrightarrow (i)$. 
	%Use the induction on 
	%$0\to M\xrightarrow{x_0}M\to M'\to 0$ to show that 
	%\[
	%	0\to \Ext^r(N,M)\xrightarrow{x_0}\Ext^r(N,M).
	%\]
\end{proof}

\begin{prop}
	Let $A$ be a Noetherian local ring and 
	$M$ be a finite $A$-module, 
	then $\depth(M)\leq \dim(A/\fp)$ for any  $\fp\in \Ass(M)$. 
	In particular  $\depth(M)\leq \dim(M)$ if  $M\neq 0$.
\end{prop}
\begin{proof}
	If $0<r\leq \depth(M)$, pick an  $M$-regular $x_0\in \fm$
	and form $0\to M\xrightarrow{x_0}M\to M'\to 0$.
	Then $r-1\leq \depth(M')$ and inductively
	$r-1\leq \dim(A/\fp')$ for any  $\fp'\in \Ass(M')$.
	Now, if  $\fp\in \Ass(M)$, then 
	 \[
		 0\to \Hom(A/\fp,M)\xrightarrow{x_0}
		 \Hom(A/\fp,M) \to 
		 \Hom(A/\fp,M')=\Hom(A/\fp+Ax, M')
	\]
	is exact. Thus Nakayama's lemma implies that 
	$\Hom(A/\fp+Ax,M')\neq 0$,
	but then there exists  $\fp'\in \Ass(M')\cap V(\fp+Ax)$,
	for which $r-1\leq \dim(A/\fp')\leq \dim(A/\fp)-1$. 
\end{proof}

\subsubsection{Kozul complex}

\begin{defn}
	For $x\in A$, let $K(x).$ be the complex 
	$\cdots0\to A\xrightarrow{x}A\to 0\cdots$.
	The tensor $C.(x)\coloneqq C.\otimes K.(x)$ 
	of which with any complex  $C.$ of $A$-modules
	is defined as the total complex of
	\[
		\begin{tikzcd}
			\cdots\arrow[r]&
			C_p\arrow[r,"d"]\arrow[d,"(-1)^{p}x"]
			\arrow[dl,dash,red]&
			C_{p-1}\arrow[r,"d"]
			\arrow[d,"(-1)^{p-1}x"]
			\arrow[dl,dash,red]&\cdots
			\arrow[dl,dash,red]\\
			\cdots\arrow[r]&
			C_p\arrow[r,"d"]&
			C_{p-1}\arrow[r,"d"]&\cdots
		\end{tikzcd}
	\]
	In general, given a sequence $(x_1,\cdots,x_n)$,
	the Kozul complex is 
	$K.(x_1,\cdots,x_n)\coloneqq 
	K.(x_1)\otimes\cdots\otimes K.(x_n)$.
	In particular,
	$H_n(\underline{x},M)=M[\underline{x}]$
	and
	$H_0(\underline{x},M)=M/(x_1,\cdots,x_n)M$.
\end{defn}
\begin{lem}
	If the sequence $(x_1,\cdots,x_n)$ is $M$-regular,
	then 
	$H_0(x_1,\cdots,x_n,M)=M/(x_1,\cdots,x_n)M$
	and
	$H_p(x_1,\cdots,x_n,M)=0$ for $p>0$.
	Conversely, 
	when $A$ is local and  $M$ is a finite  $A$-module,
	$(x_1,\cdots,x_n)$ is $M$-regular if 
	$H_1(x_1,\cdots,x_n,M)=0$.
\end{lem}
\begin{proof}
	For any complex $C.$, the above construction 
	gives an exact sequence of complexes
	$0\to C.\to C.(x)\to C.[-1]\to 0$
	and an associated long exact sequence
	$\cdots\to H_p(C.)\to H_p(C.(x))\to H_{p-1}(C.)\to \cdots$.
		
	Now, the lemma is trivial if $n=1$.
	If $n>1$ and $p>1$, then inductive
	\[
		0=H_{p}(x_1,\cdots,x_{n-1},M)\to
		H_{p}(x_1,\cdots,x_n,M)\to
		H_{p-1}(x_1,\cdots,x_{n-1},M)=0\quad
	\]
	and $0\to H_{1}(x_1,\cdots,x_{n},M)\to
	M/(x_1,\cdots,x_{n-1})\xrightarrow{x_{n}}
	M/(x_1,\cdots,x_{n-1})$
	when $p=1$.
	
	Conversely, if $H_{1}(x_1,\cdots,x_{n},M)=0$,
	then
	\[
		H_{1}(x_1,\cdots,x_{n-1},M)
		\xrightarrow{x_{n}}
		H_{1}(x_1,\cdots,x_{n-1},M)\to 0\to
		M/(x_1,\cdots,x_{n-1})
		\xrightarrow{x_{n}}
		M/(x_1,\cdots,x_{n-1}).
	\]
	Therefore $H_{1}(x_1,\cdots,x_{n-1},M)=0$
	by Nakayama's lemma 
	and $x_n$ is regular for  $M/(x_1,\cdots,x_{n-1})$.
	Inductively, $(x_1,\cdots,x_n)$ is $M$-regular.
\end{proof}


\subsection{Regular local rings}
Throughout the subsection, 
$A$ is a Noetherian local ring
with maximal ideal $\fm$ and residue field  $k=A/\fm$.
\begin{defn}
	Let $A$ be a Noetherian local ring.
	\begin{enumerate}[label=(\alph*)]
	\item 
	$A$ is regular if $\fm$ is generated by 
	$r=\dim(A)$ elements.
	\item 
	$A$ is la local complete intersection ring if
	it is the quotient of a regular local ring by 
	a regular sequence.
	\item 
	$A$ is Gorenstein if
	$\Ext^i(k,A)=0$ when $i\neq \dim(A)$ and
	$\dim_k\Ext^i(k,A)=1$  when $i=\dim(A)$.
	\item 
	$A$ is Cohen-Macaulay if  $\depth(A)=\dim(A)$.
	\end{enumerate}
\end{defn}

\subsubsection{Cohen-Macaulay}

In general, a finite $A$-module  $M$
is Cohen-Macaulay if  $\dim(M)=\depth(M)$.
then $\dim(M)=\depth(M)\leq \dim(A/\fp)$ 
for any $\fp\in \Ass(M)$.
Thus $A/I$ is equi-dimensional since
$\Supp(A/I)=\Supp(M)=\bigcup_{\fp\in\Ass(M)}\fp$.

\begin{lem}
	The followings hold when $M$ or $A$ is Cohen-Macaulay.
	\begin{enumerate}[label=(\alph*)]
		\item $\depth_\fp(M)=\depth_{A_\fp}(M_\fp)=\dim_{A_{\fp}}(M_\fp)$
		when  $M_\fp\neq 0$.
		\item a sequence  $(x_1,\cdots,x_r)$ is regular
		if and only if $\hht(x_1,\cdots,x_r)=r$.
		\item $\hht(I)+\dim(A/I)=\dim(A)$.
	\end{enumerate}
\end{lem}
\begin{proof}
	Observe that 
	$\depth_\fp(M)\leq \depth_{A_\fp}(M_\fp)
	\leq\dim_{A_{\fp}}(M_\fp)$.
	If $\depth_\fp(M)=0$, 
	then $\fp$ is minimal 
	in $\Supp(M)$ and hence $\dim(M_\fp)=0$.
	%$\depth_\fp(M)=0$ implies that 
	%$\fp$ is contained in the set of 
	%zero-divisors of  $M$,
	%and therefore contained in an associated
	%prime. But $M$ is Cohen-Macaulay.
	If $\depth_\fp(M)>0$,
	pick any non-zero-divisor $x\in \fp$,
	then $M'=M/xM$ is also Cohen-Macaulay.
	By induction on $\depth_\fp$
	\[
		 \depth_\fp(M)-1=\depth_\fp(M')=\dim(M'_\fp)=
		 \dim(M_\fp)-1.
	\]

	If $r=\dim(A)$, then $(x_1,\cdots,x_r)$
	is a system of parameters.
	In particular
	$x_1$ doesn't belong to 
	any $\fp\in \Ass(A)$.
	Otherwise $(x_2,\cdots,x_r)$
	is also a system of parameters 
	for $A/\fp$ but $\dim(A)=\dim(A/\fp)$.
	Therefore $x_1$ is regular
	and $A/(x_1)$ is also Cohen-Macaulay.
	Inductively, 
	$(x_1,\cdots,x_r)$ is regular.


	If $r<\dim(A)$, 
	there exists $x_{r+1}\in \fm$
	such that $x_{r+1}\notin\fp$
	for any minmail prime 
	$\fp$ containing $(x_1,\cdots,x_r)$.
	Then $\hht(x_1,\cdots,x_{r+1})=r+1$,
	and the sequence can be inductively
	extended to a system of parameters.
	Thus $(x_1,\cdots,x_r)$ is regular
	and $A/(x_1,\cdots,x_r)$ is 
	Cohen-Macaulay.
	Therefore for any minimal prime
	$\fp$ containing $(x_1,\cdots,x_r)$,
	$\dim(A/\fp)=\depth(A)-r
	=\dim(A)-\hht(\fp)$.

	At last, since $\hht(\fp)=\dim(A_\fp)=\depth_\fp(A)$,
	there exists a regular sequence  $(x_1,\cdots,x_r), 
	r=\hht(\fp)$, contained in $\fp$.
	And the proof above shows that 
	$\hht(\fp)+\dim(A/\fp)=\dim(A)$.
\end{proof}

\begin{enumerate}
	\item If $x_0$ is a non-zero-divisor, then
		 $A$ is Cohen-Macaulay if and only if 
		 $A/(x_0)$ is.
	 \item If $A$ is Cohen-Macaulay, so is $\hat{A}$.
	 \item If $A$ is Cohen-Macaulay, so is $A[[X]]$.
	 \item If $A$ is Cohen-Macaulay, so is $A_\fp$
		 for any prime ideal $\fp$.
\end{enumerate}

\begin{thm}
	if $A$ is CM, so is $A[[X]]$.
\end{thm}
\begin{proof}
	Let $(x_1,\cdots,x_n)$ be a regular sequence,
	with $n=\dim(A)$, then 
	it is also a system of parameters.
	Then  $(X,x_1,\cdots,x_n)$
	is both a regular sequence
	and a system of parameters for $A[[X]]$, so
	\[
		n+1\leq \depth(A[[X]])\leq \dim(A[[X]])\leq n+1.
	\]
\end{proof}


Elements of $\fm$ that are linearly independent in  $\fm/\fm^2$
are called \textbf{regular parameters}.
By Nakayama's lemma, 
$\fm$ is generated by regular parameters 
of size $\dim_k(\fm/\fm^2)$,
therefore  $\dim(A)=s(A)\leq \dim_k(\fm/\fm^2)$.
The equality holds if and only if  $A$ is regular.
When this is the case,
let $(x_1,\cdots,x_r), r=\dim(A)$,
be a set of regular parameters that generate $\fm$.
Then the natural surjection
\[
	\phi\colon k[T_1,\cdots,T_r]\to \gr^{\fm}(A),\quad T_i\mapsto x_i
\]
is an isomorphism.
Otherwise let $I=\ker(\phi)$ and consider the exact sequence
\[
	0\to I\to k[T_1,\cdots,T_r]\to \gr^{\fm}(A)\to 0
\]
If there exists some nonzero $u_h\in I_h$, then
$I_n\supset u_h(k[T_1,\cdots,T_r])_{n-h}$ for any $n\geq h$.
Therefore the Hilbert polynomial for
\begin{multline*}
	\ell(\fm^n/\fm^{n+1})=
	\dim_k(\gr^{\fm}(A))_n=\dim(k[T_1,\cdots,T_r]_n)-\dim_k(I_n)
	\\\leq
	\dim(k[T]_n)-\dim(k[T]_{n-h})=
	\binom{n+r-1}{r-1}-
	\binom{n-h+r-1}{r-1}
\end{multline*}
has degree $\leq r-2$, which is a contradiction.
Consequently $\gr^{\fm}(A)$ is a domain,
and so therefore so is  $A$ since  $\cap_n\fm^n=0$ 
by Krull's intersection.

\begin{prop}\label{prop:regular}
	Let  $I$ be an ideal of a local Noetherian ring 
	of dimension  $r=\dim(A)$.
	The followings are equivalent.
\begin{enumerate}[label=(\alph*)]
	\item 
	$A$ is regular and 
	$I$ is generated by $s$ regular parameters.
	\item  
	$B=A/I$ is regular of dimension  $r-s$
	and $I$ is generated by  $s$ element
	\item  
	$A$ is regular and  $B$ is regular of dimsnion  $r-s$
\end{enumerate}
\end{prop}
\begin{proof}
	Consider the exact sequence
	\[
		0\to I+\fm^2/\fm^2\to \fm/\fm^2\to \fn/\fn^2\to 0,\quad
		\fn\coloneqq \fm/I.
	\]
	
	If  $r=\dim_k\fm/\fm^2$ and 
	$I$ is generated by $s$ regular parameters, then
	\[
		r-s\leq \dim(B)\leq \dim_k \fn/\fn^2=r-s,
	\]
	and $B$ is therefore regular
	(the first inequality follows from Krull's principal
	ideal theorem).

	If $B$ is regular of dimension  $r-s$
	and $I$ is generated by  $s$ element, then
	\[
		r=\dim(A)\leq \dim_k(\fm/\fm^2)\leq r.
	\]

	At last, if $A, B$ are regular and $\dim(B)=r-s$,
	there exists $s$ regular parameters among generators of
	$I/\fm I\twoheadrightarrow I/I\cap \fm^2\cong I+\fm^2/\fm^2$.
	Let $I'\subset I$ be the ideal generated by them,
	then both $I'$ and  $I$ are prime ideals 
	of co-dimension  $r-s$ and thus  $I=I'$.
\end{proof}
By the above proof, when $A$ is regular and  $r=\dim(A)$,
a set of regular parameters  $(x_1,\cdots,x_r)$
is also a regular sequence since each 
$(x_1,\cdots,x_i), 1\leq i\leq r$ is a prime ideal.
In particular $\depth(A)=\dim(A)$.
\begin{rem}
Conversely, if the maximal ideal of a local Noetherian ring $A$	
is generated by a regular sequence, then
$\dim(A)\leq \dim_k(\fm/\fm^2)\leq \depth(A)\leq \dim(A)$,
and thus  $A$ is regular.
\end{rem}



\subsection{Projective dimension}


\begin{defn}
	The projective dimension of $M$,
	denoted by $\prd(M)$, is the 
	infimum length of projetive resolutions 
	$0\to L_{n}\to \cdots\to L_0$.
	The following conditions are equivalent.
	\begin{enumerate}[label=(\alph*)]
		\item $\prd(M)\leq n$.
		\item  $\Ext^i(M,N)=0$ for all $i>n$.
		\item Given  $0\to R\to L_{n-1}\to \cdots\to L_0
			\to M\to 0$ where $L_i$ are projective,
			then  $R$ is also projective.
		%$\Ext^i(R,N)\cong \Ext^{i+n}(M,N)$.
	\end{enumerate}
\end{defn}
When $A$ is Noetherian local and  $M$ is a finite  $A$-module
recall that 
\[
	M  \text{ is free } \Longleftrightarrow
	M  \text{ is prjective } \Longleftrightarrow
	M  \text{ is flat } \Longleftrightarrow
	\Tor_1(M,k)=0.
\]
%Lift a basis  $(x_1,\cdots,x_p)$ of $M\otimes k$,
%which generates $M$ by Nakayama's lemma,
%and form $0\to \ker\to A^p\to M\to 0$.
%Then 
%\[
%	 0=\Tor_1(M,k)\to N\otimes k \to A^p\otimes k
%	 \to M\otimes k\to 0 \Longrightarrow
%	 N\otimes k=0.
%\]
%implies $N=0$ by Nakayama's lemma.
\begin{rem}
	When $A$ is Noetherian
	and  $M$ is a finite $A$-module,
	the followings are equivalent.
	 \begin{enumerate}[label=(\alph*)]
		\item $M$ is flat over $A$.
		\item  $M$ is locally free.
		\item  $M$ is projective
	\end{enumerate}
	that $M$ is projective follows
	by showing $\Ext^1(M,N)=0$
	using localizations.

	Moreover, if  $A$ is a domain,
	it is equivalent to that 
	$\dim_{k(\fp)}(M\otimes A/\fp)$
	have the same dimension for all
	prime $\fp\subset A$.
	Pick any generator $x_1,\cdots,x_r$
	that generates $M\otimes A/\fp$,
	there exists  $a\notin \fp$
	such that
	 \[
		\varphi\colon A_a^r\to M_a
	\]
	is surjective,
	then use dimension to show that
	$\varphi\otimes A/Q$ is an isomorphis
	for $Q\in D(a)$,
	and conclude that  $\ker(\varphi)=0$
	using that  $A_a$ is reduced.
\end{rem}
A resolution of $M$ can be constructed as follows.
\begin{enumerate}
	\item Lift a basis of $M$ and form
		 $0\to K_1\to L_0\to M\to 0$.
	\item Lift a basis of  $K_1$ and form
		  $0\to K_2\to L_1\to K_1\to 0$ and so on.
\end{enumerate}
Such a resolution is a minimal free resolution in the sense that
all $L_i$ are free,  $L_0\otimes k\cong M\otimes k$,
and that  $\bar{d}=0$.
Any minimal free resolution is isomorphic.
From the minimal resolution of $M$, one sees that 
\[
	\prd(M)=r \Longleftrightarrow
	\Tor_{r+1}(k,M)=0 \text{ but }
	\Tor_{r}(k,M)\neq0.
\]


\begin{thm}[Auslander-Buchsbaum]
	Let $A$ be a Noetherian local ring.
	If  $M\neq 0$ is a finite  $A$-module 
	and $\prd(M)<\infty$, then
	$\prd(M)+\depth(M)=\depth(A)$.
\end{thm}
\begin{proof}
	Consider the first step 
	$0\to K_1\to L_0\to M\to 0$
	of the minimal resolution of $M$.
	If $K_1=0$, then $\prd(M)=0$ and $M$ is free,
	hence $\depth(M)=\depth(A)$.
	If $K_1\neq 0$, then $\prd(K_1)=\prd(M)-1\geq 0$ and
	from the fact that $K_1\to L_0$ is residually trivial
	the following is exact.
	\[
		0\to \Ext^i(k,L_0)\to 
		\Ext^i(k,M)\to 
		\Ext^{i+1}(k,K_1)\to 0 
	\]
	By induciton on the projective dimension,
	$\depth(K_1)=\depth(A)-\prd(K_1)\leq \depth(A)$.
	Since $\depth(M)=\inf\{i\mid \Ext^i(k,M)\neq 0\}$,
	we see $\Ext^i(k,M)\cong \Ext^{i+1}(k,K_1)$ 
	when $i<\depth(K_1)$ and therefore
	\[
		\depth(M)=\depth(K_1)-1=\depth(A)-\prd(K_1)-1
		=\depth(A)-\prd(M).
	\]
\end{proof}

\begin{thm}[Serre]
	Let $A$ be a Noetherian loccal ring
	and $k=A/\fm$ be the residue field, then
	\[
		A \text{ is regular } \Longleftrightarrow
		\prd(k)=\dim(A) \Longleftrightarrow
		\prd(k)<\infty.
	\]
\end{thm}
\begin{proof}
	Write $r=\prd(k), s=\dim_k(\fm/\fm^2)$.
	If $\fm=\fm^2$, then $\fm=0$ and $s=0$, hence  $r=0$.
	If $\fm\neq \fm^2$, then  $s>0$.
	Note also that  $\fm\notin\Ass(M)$,
	for an injection $k\hookrightarrow A$ 
	would imply $\Tor_r(k,k)=0$.
	Thus there exists 
	$x\in \fm\setminus \fm^2\cup\bigcup_{\in \Ass(A)}\fp$,
	which is regular and $\fm$-regular.
	Let $B=A/(x)$, then
	$\Tor_i(\fm,B)=0$ for  $i\geq 1$.
	%Use the resolution 
	%$0\to A\xrightarrow{x}A\to B\to 0$
	%and that $x$ is $\fm$-regular.
	Therefore if $L_*\to \fm\to 0$ is a projective resolution,
	then  $L_*\otimes B\to \fm\otimes B\to 0$
	is a projective resolution and
	\[
		\Ext_A^i(\fm,N)=\Ext_B^i(\fm/x\fm, N) 
		\text{ for all $B$-module $N$.}
	\]
	Moreover, $\fm/xA$ is a direct summand of  $\fm/x\fm$:
	Pick a minimal basis $x=x_1,\cdots,x_s$ of $\fm$
	and set $\mathfrak{b}=(x_2,\cdots,x_s)$,
	then $\mathfrak{b}\cap (x)\subset x\fm$ and 
	the composition 
	$\fm/xA=(\mathfrak{b}+(x))/(x)\cong 
	\mathfrak{b}/\mathfrak{b}\cap (x)\to
	\fm/x\fm\to \fm/xA$ is the indentity.
	Therefore
	\[
		\prd_B(\fm/xA)\leq \prd_B(\fm/x\fm)
		\leq \prd(\fm)\leq r
	\]
	Combine a resolution of $\fm/xA$
	with $0\to \fm/xA\to B\to k\to 0$,
	we see $\prd_B(k)<\infty$ as well.
	Thus $B$ is regular by induction on 
	$\dim_k(\fm/\fm^2)$.
	And  $A$ is also regular by Proposition \ref{prop:regular}
	since $x$ is regular.
\end{proof}

If $\fp$ is a prime ideal,
there exists a projctive resolution
$L_*\to A/\fp\to 0$ of finite length.
Then $L_*\otimes A_\fp\to (A/\fp)\otimes A_\fp\to 0$
is a projective resolution of the residue field of $A_\fp$.
Therefore  $A_\fp$ is also regular.

\begin{enumerate}
	\item If $x_0$ is a non-zero-divisor, then
		 $A$ is regular if and only if 
		 $A/(x_0)$ is.
	 \item If $A$ is regular, so is $\hat{A}$.
	 \item If $A$ is regular, so is $A[[X]]$.
	 \item If $A$ is regular, so is $A_\fp$
		 for any prime ideal $\fp$.
\end{enumerate}

\subsection{Serre criterion}

Recall that a ring $A$ is normal if 
$A_P$ is an integrally-closed domain for all prime $P$.
\begin{prop}
	The following conditions for a ring $A$
	are equivalent.
	\begin{enumerate}[label=(\roman*)]
		\item $A$ is a discrete valuation ring.
		\item $A$ is a local PID but not a field
		\item $A$ is a Noetherian local ring
			of $\dim A>0$ and $\fm$ is principal.
		\item  $A$ is a one-dimensional normal 
			Noetherian local ring.
	\end{enumerate}
\end{prop}
\begin{proof}
	Suppse $(iii)$ holds.
	Then $\fm^n\neq 0$ for any  $n\geq 0$ since  $\dim A>0$
	but $\cap_n\fm^n=0$ by Krull's intersection.
	Therefore for any  $y\neq0$ there exists  $n\geq 0$
	such that  $y\in \fm^n$ but  $y\notin \fm^{n+1}$.
	Fix a generator $\fm=(x)$,
	then $y=ux^n$, where $u\notin\fm$ is a unit.
	Such a decomposition shows that 
	$A$ is a discrete valuation ring.
	
	On the other hand suppose $(iv)$ holds,
	in particular $A$ is an integral domain
	and $\{0\}$ and $\fm$ are the only prime ideals of  $A$.
	Since then $\fm\neq\fm^2$, 
	one may pick $x\in \fm\setminus\fm^2$ and 
	conclude that $\fm\in \Ass(A/(x))$.
	In other word, there exists $y\in A$ such that
	$((x):y)=\fm$.
	Put  $a=yx^{-1}\in K\setminus A$ and define
	$\fm^{-1}=\{b\in K\mid b\fm\subset A\}$.
	Then $\fm\subset \fm^{-1}\fm\subset A$ 
	since $A\subset \fm^{-1}$.
	But $\fm^{-1}\fm=\fm$ cannot happen,
	for otherwise $a\fm\subset \fm$
	provide an integral relation of $a$
	through the characteristic polynomial.
	Thus $\fm^{-1}\fm=A$ and any relation 
	\[
	1=\sum_{i}a_ib_i,\quad a_i\in\fm, b_i\in \fm^{-1}
	\]
	implies that $a_ib_i$ is a unit for some  $i$,
	thus  $a_i\fm^{-1}=A$ and $\fm=(a_i)$
	(in fact $x\fm^{-1}=A$ since $x\notin\fm^2$).
\end{proof}
\begin{prop}
	Let $A$ be a normal Noetherian domain,
	then $A$ satisfies the following properties.
	\begin{enumerate}
		\item $\hht P=1$ for any principal ideal $(x)$
			and any $P\in \Ass(A/(x))$.
		\item $A=\cap_{\hht P=1}A_P$.
	\end{enumerate}
\end{prop}
\begin{proof}
	Suppose $P\in \Ass(A/(x))$ and pick  
	$y\in A$ such that $((x):y)=P$.
	Localize to $A_P$ and let $\fm=PA_P$,
	the same argument as above shows that
	$\fm$ is invertible, 
	hence  $\dim A_P=1$
	by the same proposition.

	For the second statement,
	suppose $b/a\in \cap_{\hht P=1}A_P$ for $a,b\in A$
	and let $(a)=N_1\cap\cdots\cap N_r$
	be the shortest primary decomposition.
	Write $\Ass(A/N_i)={P_i}$,
	where the $P_i$'s are distinct,
	so that $\Ass(A/(a))=\{P_i\}$.
	Then $\hht P_i=1$ and
	$b\in aA_{P_i}\cap A=N_i$ for all $i$,
	hence $b\in(a)$.
\end{proof}

Consider the following conditions for a Noetherian ring $A$.
\begin{align*}
	(R_i)&\colon 
	A_P\text{ is regular for all prime $P$ such that }
	\hht P\leq i.\\
	(S_i)&\colon 
	\depth A_P\geq \min\{\hht P, i\} \text{ for all prime }P.
\end{align*}
\begin{itemize}
	\item $S_1$ means all associated primes are minimal,
		since any non-minimal ideal 
		contains non-zero-divisor.
	\item  $R_0+S_1$ iff  $A$ is reduced.
	\item  $S_k$ for all  $k$ implies Cohen-Macaulay.
\end{itemize}

A ring is normal if $A_P$ is an integral domain 
\begin{thm}
	$R_1+S_2$ iff  $A$ is normal.
\end{thm}
\begin{proof}
	Since $A$ is  $R_0+S_1$ is reduced,
	 $0=P_1\cap \cdots\cap P_r$ for minimal ideals.
	 Let $K=A/P_1\times\cdots\times A/P_r$.
	 If $a/b\in K$ for  $b$ regular is integral over  $A$
	  \[
		  (a/b)^n+c_1(a/b)^{n-1}+\cdots+c_n=0
		  \Longleftrightarrow
		  a^n+\sum c_ia^{n-i}b^i=0.
	 \]
	 By $(R_1)$ $A_P$ is regular if  $\hht P=1$ and thus normal,
	 so  $a\in bA_P$.
	 By  $(S_2)$ prime divisors of  $bA$ have height one
	 since  $b$ is regular,
	 
	 Thus  $a/b\in A$.
	 In particular the idempotents are in $A$
	 but that implies $r=1$, so $A$ is integral closed domain.
\end{proof}

\section{Spectran sequence}

\begin{lem}
	Let $T\colon C\to C'$ an $S\colon C'\to C''$
	be two additive functors between abelian categories
	such that $S$ is left exact 
	and $R^qS(TQ)=0$ for $q>1$ if $Q\in C$ is injective.
	Then $E^{p,q}_2=R^qS(R^pT(A))\Longrightarrow 
	R^{p+q}(S\circ T)(A)$, in particular
	there is the exact sequence
	\[
		0\to R^1S(T(A))\to R^1(S\circ T)(A)\to 
		S(R^1TA)\to R^2S(T(A))\to R^2(S\circ T)(A).
	\]
\end{lem}
\begin{proof}
	Let $A\to Q^*$ be an injective resolution,
	there is an Cartan-Eillenberg resolution
	$TQ^*\to J^{**}$ such that 
	\begin{enumerate}[label=(\alph*)]
	\item Each  
	$0\to T(Q^q)\to \cdots\to J^{p,q}\to\cdots$ 
	is an injective resolution.
	\item Each  
	$0\to Z^q(TQ^*)\to \cdots\to Z^q(J^{p,*})\to\cdots$ 
	is an injective resolution.
	\item Each  
	$0\to B^q(TQ^*)\to \cdots\to B^q(J^{p,*})\to\cdots$ 
	is an injective resolution.
	\item Each  
	$0\to H^q(TQ^*)\to \cdots\to H^q(J^{p,*})\to\cdots$ 
	is an injective resolution.
	\end{enumerate}
	Consider the double complex below.
	Then $\prescript{}{I}{E}_1^{p,q}=R^pS(TQ^q)=0$ for $p>0$
	and $\prescript{}{I}{E}_2^{0,q}=R^q(S\circ T)(A)$. 
	On the other hand, 
	$\prescript{}{II}{E}_1^{p,q}=H^q(S(J^{p,*}))=S(H^q(J^{p,*}))$
	since both
	$0\to Z^{p,q}\to J^{p,q}\to B^{p+1,q}\to 0$ and
	$0\to B^{p,q}\to Z^{p,q}\to H^{p+1,q}\to 0$ split.
	But $H^q(J^{p,*})$ is an injective resolution of $R^qT(A)$,
	so  $\prescript{}{II}{E}_1^{p,q}\cong R^pS(R^qT(A))$.
\[
\begin{tikzcd}[row sep=small]
	0 \arrow[r] &
	S(TQ^0) \arrow[r]\arrow[d,dashed] & \cdots \arrow[r]&
	S(TQ^q)\arrow[r]\arrow[d,dashed] & \cdots \\
	0 \arrow[r] &
	S(J^{0,0}) \arrow[r]\arrow[d] & \cdots \arrow[r]&
	S(L^{0,q}) \arrow[r]\arrow[d] & \cdots \\
	&
	\vdots \arrow[d]& \ddots&
	\vdots \arrow[d]& \ddots \\
	0 \arrow[r] &
	S(L^{p,0}) \arrow[r]\arrow[d] & \cdots \arrow[r]&
	S(L^{p,q}) \arrow[r]\arrow[d] & \cdots \\
	&
	\vdots & \ddots&
	\vdots & \ddots 
\end{tikzcd}
\]
\end{proof}
\begin{itemize}
	\item Let $X$ be a ringed space 
	and $F,G$ are $\mathcal{O}_X$-modules, then
	$H^p(X,\underline{\Ext}^1_{\mathcal{O}_X}(F,G))
	\Longrightarrow \Ext^{p+q}_{\mathcal{O}_X}(F,G)$.
	\item Let $f\colon X\to Y$ be a morphism of ringed space,
	then $H^p(Y, R^qf_*F)\Longrightarrow H^{p+q}(X,F)$.
\end{itemize}

\section{Flat}

\begin{defn}
	An $A$-module $M$ is flat if the sequence
	$N'\otimes_AM\to N\otimes_AM\to N^{''}\otimes_AM$ is exact
	when $N'\to N\to N''$ is exact.
	The followings are equivalent.
\begin{enumerate}
	\item $M$ is flat.
	\item $I\otimes_AM\to IM$ is bijective.
	\item $\Tor_1(M,A/I)=0$ for any ideal $I$.
	\item $\Tor_1(M,N)=0$ for any $N$.
\end{enumerate}
%If $\Tor_1(M,A/I)=0$ for any ideal $I$, 
%inductively $\Tor_1(M,N)=0$ for any finite $A$-module $N$,
%hence $\Tor_1(M,N)=\varinjlim\Tor_1(M,N_i)=0$ 
%for any $A$-module.
	An $A$-module $M$ is faithfully flat if 
	a sequence $N'\to N\to N''$ is exact if and only if
	$N'\otimes_AM\to N\otimes_AM\to 
	N^{''}\otimes_AM$ is exact.
	The followings are equivalent.
\begin{enumerate}
	\item $M$ is faithfully flat.
	\item $M$ is flat and $M\otimes_AN=0$ implies  $N=0$.
	\item $M$ is flat and $M\otimes A/\fm\neq 0$
	for all maximal ideal  $\fm$.
\end{enumerate}
Note that when $A$ is a local ring, 
a finite $A$-module $M$ is faithfully flat if and only if 
it is flat and nonzero.
\end{defn}
The statements below are still true if all
instances of \red{flat} are replaced by faithfully flat.
\begin{itemize}
	\item If $M,N$ are \red{flat} over $A$,
	then  $M\otimes_AN$ is \red{flat} over $A$.
	\item If $M$ is \red{flat} over $A$
	then $M\otimes_AB$ is \red{flat} over $B$.
	\item If $B$ is \red{flat} over  $A$ and 
	$P$ is \red{flat} over $B$, 
	then $P$ is \red{flat} over $A$.
	\item If $B$ is faithfully flat over $A$ 
	and $M\otimes_AB$ is \red{flat} over $B$,
	then $M$ is \red{flat} over $A$.
\end{itemize}

\begin{lem}
	Let $\varphi\colon A\to B$ be a ring homomorphism,
	the followings are equivalent.
\begin{enumerate}
	\item $B$ is faithfully flat over $A$.
	\item $B$ is flat over $A$ and 
	 $M\to M\otimes_AB$ is injective for any  $A$-module $M$.
	\item  $\varphi$ is injective and 
	$B/\varphi(A)$ is flat over $A$.
	\item  $I\otimes_AB\to IB$ is bijective
	and  $\varphi^{-1}(IB)=I$ for any ideal $I\subset A$.
\end{enumerate}
\end{lem}
\begin{proof}
	When $B$ is faithfully flat,
	since $M\otimes_AB\to M\otimes_AB\otimes_AB$
	has a natural left inverse,
	the kernel of $M\to M\otimes_AB$ is trivial.
	Assume either (ii) or (iii),
	then $\varphi$ is injective and 
	\[
		 0\to\Tor_1(M,B)\to \Tor_1(M,B/\varphi(A))\to 
		 M\to M\otimes_AB\to M\otimes_AB/\varphi(A)\to 0.
	\]
	From which one sees that (ii) and (iii) are equivalent.
	Assume (ii), then $I\otimes_AB\to IB$ is bijective and
	\[
		0\to A/I\to (A/I)\otimes_AB=B/IB \Longrightarrow
		\varphi^{-1}(IB)=I.
	\]
	Assume (iv), then $B$ is flat 
	and  $\fm B\neq B$ for any maximal ideal  $\fm\subset A$,
	thus  $B$ is faithfully flat.
\end{proof}

\begin{rem}
	When $f\colon A\to B$ is flat and  $a\in A$ is not a zero-divisor,
	then  $f(a)$ is not a zero-divisor.
	Conversely, if $A$ is a DVR and $B$ is integral,
	and  $f$ is injective, then  $f\colon A\to B$ is flat.
\end{rem}

The following criterion is equivalent to
that $I\otimes_AM\to IM$ is bijective:
If  $\sum_{i=1}^ra_ix_i=0$ for $a_i\in I, x_i\in M$,
then there exists  $b_{ij}\in A$ and $y_j\in M$ such that
$\sum_{i=1}^ra_ib_{ij}=0$ and  $x_i=\sum_{j}b_{ij}y_j$.
Consider the map
\[
	 \varphi\colon A^r\to A\quad
	 \varphi(t_1,\cdots,t_r)=
	 \sum a_it_i
\]
It then follows from the flatness of $A$ that
$x=(x_1,\cdots,x_r)\in \ker(\varphi)\otimes_AM$,
there exists $y_j\in M$ and  $b_j\in \ker$
such that  $x=\sum b_j\otimes y_j$.
Conversely, if $\sum a_ix_{i}=0$ for $a_i\in I, x_i\in M$ 
implies the existence of $b_{ij}\in A$ and $y_j\in M$ as above,
then
\[
	\sum a_i\otimes x_i=
	\sum a_i\otimes \sum_j b_{ij}y_j=
	\sum_i \sum_ja_ib_{ij}\otimes y_j=
	0.
\]

\begin{prop}
	Suppose $B$ is a flat  $A$-algebra
	and  $b\in B$ is not a zero-divisor in  $B/\fm B$
	for any maximal ideal  $\fm$ of  $A$,
	then $B/(b)$ is flat over $A$.
	Inductively if $b_1,\cdots,b_r$
	is a $B/\fm B$-regular sequence,
	then  $B/(b_1,\cdots,b_r)$ is flat over $A$.
\end{prop}
\begin{proof}
	First show that $b$ is not a zero-divisor in  $B$,
	which can be reduced to the case
	when $A\to B$ is a local homomorphism between local rings.
	Now $cb=0$ implies $c\in\fm B$.
	Suppose inductively that $c\in \fm^nB$
	and write $c=\sum a_ib_i$,
	where  $\{a_i\}$ is a minimal generating set of $\fm^n$.
	Since $B$ is flat, there exists 
	$a'_{ij}\in A$ and $y_j\in B$
	such that $\sum_ia_ia'_{ij}=0$ and $b_ib=\sum a'_{ij}y_j$.
	Then $a'_{ij}\in\fm$ from the minimality of $\{a_i\}$,
	hence $b_ib\in\fm B$ and $b_i\in\fm B$,
	from which  $c\in \fm^{n+1}B$.
	Thus $c=0$ by Krull's intersection.
	Since the same argument holds for
	$B/IB$, where $I\subset A$ is any ideal,
	The diagram below implies that $B/(b)$ is flat over  $A$.
	\[
		\begin{tikzcd}
		&I\otimes B \arrow[r]\arrow[d,hookrightarrow] &
		I\otimes B \arrow[r]\arrow[d,hookrightarrow] 
		& I\otimes(B/(b))\arrow[d]\arrow[r]&0\\
		0\arrow[r]&B \arrow[r,"b"]\arrow[d] &
			B \arrow[r]\arrow[d] &
			B/(b)\arrow[r]&0 \\
		0\arrow[r]&B/IB \arrow[r,"b"] &
			B/IB&
		\end{tikzcd}
	\]
\end{proof}
Consequently, 
a hypersurface $Z$ in $B=A[X_1,\cdots,X_n]$ is flat over $A$
if the coefficients defining of the polynomial defining $Z$
generate $A$.
This generalizes to the propositions
below on dimensions of closed fibers.


\subsection{flat morphism}
\begin{defn}
	Let $f\colon X\to Y$ be a morphism of schemes
	and  $F$ be an $\mathcal{O}_X$-module.
	We say $F$ is flat over $Y$ if $F_x$ is  
	$\mathcal{O}_{f(x)}$-flat for any $x\in X$,
	faithfully flat if $F$ is flat 
	\begin{enumerate}
	\item $F$ is flat over $Y$ if $F_x$ is 
	$\mathcal{O}_{f(x)}$-flat for every $x\in X$.
	\item  $F$ is faithfull flat over $Y$ if 
	$F$ is flat over $Y$ and $F\otimes k(y)\neq 0$
	for every $y\in Y$.
	\end{enumerate}

	The morphism $f$ is quasi-flat if 
	there exists a quasi-coherent $F$ of finite type
	which is flat over $Y$ and $\Supp(F)=X$,
	and quasi-faithfully flat if it is furthermore surjective.
	The morphism $f$ is flat or faithfully flat
	when $\mathcal{O}_X$ can be taken for $F$.
\end{defn}

\begin{itemize}
	\item An open immersion is flat.
	\item Compositions of \red{flat} morphisms are \red{flat}.
	\item Base changes of \red{flat} morphisms are \red{flat}.
	\item Products of \red{flat} morphisms are \red{flat}.
\end{itemize}

\begin{prop}
	Let $f\colon X\to Y$ be a morphism of schemes
	and  $F$ be a quasi-coherent $\mathcal{O}_X$-module.
	\begin{itemize}
		\item If $X,Y$ are affine,
		$F$ is \red{flat} over $Y$ if and only if
		$M=\Gamma(X,F)$ is \red{flat}
		over $A=\Gamma(Y,\mathcal{O}_Y)$.
		\item If $F$ is of finite type,
		$F$ is faithfully flat over $Y$
		if an only if $F$ is flat over $Y$
		and $f(\Supp(F))=Y$.
	\end{itemize}
\end{prop}
\begin{proof}
	Let $\varphi\colon A\to B$ be a ring homomorphism
	and  $M$ be a $B$-module.
	Suppose  $M_\wp$ is  $A_\fp$-flat for any prime  $\wp\subset B$
	and  $\fp=\wp\cap A$,
	then for any ideal  $I\subset A$, the flatness implies that
	 \[
		 (I\otimes_AM)_\wp=I_\fp\otimes_{A_\fp}M_\wp\to M_\wp
	\]
	is injective, thus $I\otimes_AM\to IM$ is injective as well
	and $M$ is flat over  $A$.
	Conversely, if  $M$ is  $A$-flat, then for any  $A_\fp$-module  $N$,
	the functor  $N\otimes_{A_\fp}M_\wp=(N\otimes_AM)_\wp$ is exact,
	so $M_\wp$ is  $A_\fp$-flat.

	For (ii), if  $F\otimes k(y)\neq 0$, 
	then  $\mathcal{O}_X\otimes k(y)\neq 0$
	and there exists $x\in f^{-1}(y)$ 
	such that $F\otimes \mathcal{O}_x\neq 0$.
	Conversely, if $F_x\neq0$ is flat over $\mathcal{O}_y$
	for  $y=f(x)$ 
	under the local homomorphism  $\mathcal{O}_y\to \mathcal{O}_x$,
	then it is faithfully flat.
\end{proof}

\begin{prop}
    Let $\varphi\colon A\to B$ be a local homomorphism
    of Noetherian local rings, then
    \[
        \dim(B)\leq \dim(A)+\dim(B\otimes_Ak).
    \]
    Furthermore, the equality holds 
    when either of the followings holds.
    \begin{enumerate}[label=(\roman*)]
        \item there exists a nonzero finite $B$-module $M$ 
	with $\Supp(M)=B$ which is flat over $A$.
        \item for all prime $\fp\subset A$ not equal to $\fm$ 
	and all minimal prime $\fq$ of $\fp B$, 
	$\varphi^{-1}(\fq)\neq \fm$.
    \end{enumerate}
\end{prop}
\begin{proof}
	Let $I\subset A$ be an ideal generated
	by a system of parameters of size  $d=\dim(A)$.
	Then $A/I$ is Artinian and $\fm/I$ is nilpotent,
	consequently $\fm B/IB$ is nilpotent and 
	\[
		\dim(B\otimes_Ak)=\dim(B/IB)\geq \dim(B)-d.
	\]
	
	If $\dim(A)=0$, then  $\fm$ and hence $\fm B$
	are nilpotent, therefore $\dim(B)=\dim(B/\fm B)$.
	%(ii) holds trivially in this case.
	If $\dim(A)>0$,
	let  $\{\fq_i\}$ be the set of minimal primes of $B$ and
	$\{\fp'_i\}$ be the set of minimal primes of $A$.
	Then (ii) implies that
	$\fp_i\coloneqq \fq_i\cap A\neq \fm$,
	for otherwise $\fq_i$ is also minimal 
	among primes containing  $\fp B$ for some $\fp\subset \fm$.

	Thus there exists $x\in \fm\setminus \cup\fp'_i\cup\fp_i$.
	Put $A'=A/xA, B'=B/xB$,
	then $\dim(A')=\dim(A)-1,\dim(B')=\dim(B)-1$,
	and $\dim(B\otimes_Ak)=\dim(B'\otimes_{A'}k)$.
	Since $\varphi'\colon A'\to B'$
	is still a local homomorphism satisfying (ii),
	the proposition follows by induction on  $\dim(A)$.

	At last, suppose (i) holds.
	If  $\fq\subset B$ is minimal among primes of $B$
	containing  $\fq B$ for some  $\fp\neq \fm$
	such that $\varphi^{-1}(\fq)=\fm$,
	then  $A\to B\to B_\fq$ is stil a local homomorphism.
	Since the functor 
	$N\otimes_AM_\fq=(N\otimes_AM)\otimes_BB_\fq$
	is exact for any  $A$-module $N$,
	$M_\fq\neq 0$ is flat and thus faithfully flat over $A$.
	Thus $f\colon \Spec(B_\fq)\to \Spec(A)$
	is surjective and there exists a prime $\fq'\subset \fq$ 
	which restricts to $\fp$, constradicting the minimality.
\end{proof}

\subsection{local criterion}

\begin{thm}\label{thm:criterion}
	The following conditions on an $A$-module $M$
	satisfies the relation
	\[
		(i)\Longrightarrow 
		(ii) \Longleftrightarrow (ii')\Longleftrightarrow 
		(iii) \Longleftrightarrow (iii') \Longrightarrow
		(iv) \Longleftrightarrow (v).
	\]
	\begin{enumerate}[label=(\roman*)]
		\item $M$ is flat.
		\item  $M/IM$ is $A/I$-flat and $\Tor_1(M,A/I)=0$.
		\myprimeitem  $M/IM$ is $A/I$-flat 
		and $I\otimes_AM\to IM$ is bijective.
		\item $\Tor_1(M,N)=0$ for all $A$-module $N$ annihilated by $I$.
		\myprimeitem $\Tor_1(M,N)=0$ 
		for all $A$-module $N$ annihilated by $I^s$ for some $s$.
		\item $M\otimes_A(A/I^s)$ is flat over $A/I^s$ for all $s$.
		\item  $M/IM$ is $A/I$-flat and 
			$\gr_I^0(M)\otimes_{A/I}\gr_I^*(A)\to \gr_I^*(M)$
			is an isomorphism.
	\end{enumerate}
	Furthermore, they are equivalent
	when either of the following assumptions holds.
	\begin{itemize}
		\item $I$ is nilpotent.
		\item $A$ is Noetherian and $M$ is a finite  $B$-module
		for a Noetherian $A$-algebra $B$ such that $IB\subset\rad(B)$.
	\end{itemize}
\end{thm}
\begin{proof}
	The equivalence between $(ii)$ and $(iii)$ follows from 
	the exact sequence
	\[
		N\otimes_{A/I}\Tor^A_1(M,A/I)\to 
		\Tor^A_1(M,N)\to 
		\Tor^{A/I}_1(M/IM,N)\to 0,
	\]
	which comes from the spectral sequnce  
	$\Tor^{A/I}_p(\Tor^A_q(M,A/I),N)\Longrightarrow\Tor_{p+q}^A(M,N)$.
	That $(iii)$ implies $(iii')$ follows by considering inductively
	$\Tor_1(M,IN)\to \Tor_1(M,N)\to \Tor_1(M,N/IN)$.
	That $(iii')\Longrightarrow(v)$ in general and 
	$(v)\Longrightarrow(ii')$ when $I$ is nilpotent 
	can be obtained from the diagram below.
	\[
		\begin{tikzcd}
			&I^{s+1}\otimes_AM\arrow[d]\arrow[r]
				&I^{s}\otimes_AM\arrow[d]\arrow[r]
					& \gr^s_I(A)\otimes_{A/I}
					\gr^0_I(M) \arrow[r]\arrow[d]
						&0\\
		0\arrow[r]
			&I^{s+1}M\arrow[r]
				&I^{s}M\arrow[r]
					&\gr^s_I(M)\arrow[r]
						&0
		\end{tikzcd}
	\]
	For each $n\geq1$, let  $(*)_n$ denote the same conditions
	for  $A/I^n$ and  $M/I^nM$.
	Then $(iv)\Longrightarrow(i)_n\Longrightarrow(v)_n$ for all  $n\geq 1$,
	but then $(v)$ holds since
	$\gr^s_{I/I^n}(M/I^nM)=\gr^s_I(M)$ when $s\leq n$.
	Conversely $(v)\Longrightarrow(ii)_n\Longrightarrow(iv)_n$
	for all $n\geq1$ since $I/I^n$ is nilpotent.
	Thus $(iv)$ also holds.

	To prove that $(iv)\Longrightarrow(i)$ under the second condition,
	observe that 
	\[
		 N'/(I^rN\cap N')\otimes_{A/I^r}(M/I^rM)\hookrightarrow
		 N/I^rN\otimes_{A/I^r}(M/I^rM),
	\]
	is injective for any injection 
	$N'\hookrightarrow N$ between $A$-modules. 
	By Artin-Rees, there exists $k\geq 0$
	such that  $I^rN\cap N'=I^{r-k}(I^kN\cap N')$.
	Let $M'$ be the image of  $(I^kN\cap N')\otimes_AM$
	in  $N'\otimes_AM$ and rewrite the above as
	$N'\otimes_AM/I^{r-k}M'\hookrightarrow N\otimes_AM/I^rM$.
	Therefore
	$(N'\otimes_AM)^\wedge\to(N\otimes_AM)^\wedge$ is injective,
	since $(I^{r-k}M')$ also induces 
	the $I$-adic topology on $N'\otimes_AM$.
	At last, since by Krull's intersection
	$N'\otimes_AM\hookrightarrow (N'\otimes_AM)^\wedge$
	is injective and similar for $N$,
	we see $N'\otimes_AM\hookrightarrow N\otimes_AM$
	is injective, which implies  $(i)$.
\end{proof}

\begin{prop}\label{prop:flat_completion}
	Let $A\to B$ be a ring homomorphism between Noetherian rings,
	$I\subset A$ and  $I'\subset B$
	are ideals such that $IB\subset I'\subset \rad(B)$.
	Let  $M$ be a finite  $B$-module and 
	$\hat{M}$ be the $I'$-adic completion, then
	\[
		M\text{ is }A\text{-flat}\Longleftrightarrow
		\hat{M}\text{ is }A\text{-flat}\Longleftrightarrow
		\hat{M}\text{ is }\hat{A}\text{-flat}.
	\]
\end{prop}
\begin{proof}
	The first equivalence follows from that 
	$\hat{B}$ is faithfully over $B$ and $M\otimes_B\hat{B}=\hat{M}$.
	Since $\hat{A}, \hat{B}$ are Noetherian,
	$\hat{M}$ is $\hat{B}$-finite,
	and $ \hat{A}/\hat{I}^s\cong A/I^s$ for all $s$,
	the second equivalence follows from 
	$(i)\Longleftrightarrow(iv)$ of the theorem.
\end{proof}

\begin{prop}[fiberwise criterion]
	Let $R\to A$ and $A\to B$ be local homomorphism
	of Noetherian rings and $M$ be a finite $B$-module.
	Suppose $A$ is flat over  $R$,
	the the followings are equivalent.
	 \begin{enumerate}[label=(\alph*)]
		\item $M$ is flat over $A$.
		\item  $M$ is flat over  $R$
		and $M\otimes_Rk$ is  lat over $A\otimes_Rk$,
		where $k$ is the residue field of $R$.
	\end{enumerate}
\end{prop}
\begin{proof}
	Let $\fm\subset R$ be the maximal ideal 
	and apply $(i)\Longrightarrow(v)$ of
	the theorem to $I=\fm A$ yields
	\[
		(M/IM)\otimes_k\gr^*_\fm(R)\cong \gr^*_I(M),\,
		(A/I)\otimes_k\gr^*_\fm(R)\cong \gr^*_I(A)\Longrightarrow
		(M/IM)\otimes_{A/I}\gr^*_I(A)\cong \gr^*_I(M).
	\]
\end{proof}

\begin{prop}
	Let $A\to B$ be a local homomorphism of Noetherian rings,
	$M$ be a fintie $B$-module, 
	$\fm\subset A$ the maximal ideal, and $k=A/\fm$.
	Then $M$ is flat over  $A$ if the following assumptions hold.
	  \begin{itemize}
	 	\item $A$ is a regular local ring.
		\item $M$ is a Cohen-Macaulay $B$-module.
		\item  $\dim_B(M)=\dim(A)+\dim_{B\otimes_Ak}(M\otimes_Ak)$
	 \end{itemize}
\end{prop}
In particualr, let $A\to B$ be a squasi-finite 
local homomorphism of regular local rings having the same dimension,
then  $B$ is flat over  $A$,
since quasi-finite implies  $\dim(B\otimes_Ak)=0$.

\begin{proof}
	Since $M\otimes_Ak$ is necessarily
	flat over the field  $k$,
	the goal is to show that $\Tor_1(M,k)=0$
	and apply $(i)\Longleftrightarrow(ii)$
	of the theorem. 
	Let  $x_1,\cdots,x_r, r=\dim(A)$,
	be regular parameters of $A$.
	Then
	 \[
		 \dim(M\otimes_Ak)
		 =\dim_B(M/(x_1,\cdots,x_r)M)
		 =\dim_B(M)-\dim(A)
	\]
	implies that $(x_1,\cdots,x_r)$
	is a $M$-regular sequence.
	Define  
	$M_i=M/(x_1,\cdots,x_i)$ and 
	$A_i=A/(x_1,\cdots,x_i)$.
	Since $(x_1,\cdots,x_r)$
	is also an $A$-regular sequence
	by the regularity of $A$, 
	the long exact sequence
	\[
	\Tor_1(M,A_i)\to
	\Tor_1(M,A_{i+1})\to
	M_i\xrightarrow{x_{i+1}} M_i
	\]
	associated to 
	$0\to A_i\xrightarrow{x_{i+1}}
	A_i\to A_{i+1}\to 0$
	shows inductively that
	$\Tor_1(M,A_{i})=0$ for all $i$.
\end{proof}

\subsection{constructible sets}

\begin{defn}
	A subset $Z\subset X$ is constructible 
	if it is a finite union of locally closed subsets in  $X$.
\end{defn}
\begin{itemize}
	\item Open sets and closed sets are constructible.
	\item If $Z$ and  $Z'$ are constructible,
		then so are  $Z\cup Z'$ and  $Z\cap Z'$.
	\item If  $f\colon Y\to X$ is continuous and  
		$Z\subset X$ is constructible, then so is $f^{-1}(Z)$.
	\item If  $Z$ is constructible in  $Y$ and 
		$Y$ is constructible in  $X$, 
		then $Z$ is constructible in  $X$.
\end{itemize}


\begin{lem}
	Let $Z$ be a subset of a Noetherian space  $X$.
	Then $Z$ is constructible if and only if 
	for all closed irreducible subset $Y$,
	such that $Z\cap Y$ is dense in $Y$,
	$Z\cap Y$ contains 
	a non-empty open subset of  $Y$.
\end{lem}
\begin{proof}
	If $Z=\cup_{i=1}^nF_i\cap V_i$ is constructible,
	where $F_i$ are closed and $V_i$ are open in $X$,
	write $Z\cap Y=\cup_{i=1}^nF'_i\cap V'_i$,
	where $F_i'=F_i\cap Y$ and  $V_i'=V_i\cap Y$.
	If $Z\cap Y$ is dense in $Y$,
	then  $Y=F'_i$ for some  $i$ and therefore
	$V'_i=F'_i\cap V'_i\subset Z\cap Y$
	is an open subset in  $Y$.

	Conversely,
	suppose $Z$ is not constructible,
	there exists a closed subset $Y\subset X$ which is
	minimal among closed subsets such that 
	$Z\cap Y$ is not constructible in $Y$.
	Then either
	\begin{enumerate}
		\item $Y=Y_1\cup Y_2$ is not irreducible,
		but then  $Z\cap Y=Z\cap Y_1\cup Z\cap Y_2$
		is constructible.
		\item  $Y$ is irreducible but  
		$Z\cap Y$ is not dense in  $Y$,
		then $Z=Z\cap \overline{Z\cap Y}$ is constructible.
		\item $Y$ is irreducible and 
		$Z\cap Y$ is dense in  $Y$,
		by assumption there exists an open subset 
		$V\subset Z\cap Y$ of $Y$
		but then $Z\cap Y=V\cup Z\cap (Y\setminus V)$
		is constructible.
	\end{enumerate}
\end{proof}
\begin{lem}
	Let $Z$ be a constructible subset 
	of a Noetherian space  $X$ and $x\in Z$.
	Then  $Z$ is a neighborhood of $x$
	if and only if $Z\cap Y$ is dense in  $Y$
	for any closed irreducible subset  $Y$
	containing  $x$.
\end{lem}
\begin{proof}
	Suppose $Z$ is not a neighborhood of  $x$,
	there exists a closed subset $Y\subset X$
	which is minimal among closed subsets such that
	$Z\cap Y$ is not a neighborhood of  $x$ in  $Y$.
	If $Y=Y_1\cup Y_2$ is not irreducible, either
	\begin{enumerate}
	\item $x\in Y_1$ and $x\in Y_2$,
	then there exists open sets $V'_1,V'_2$
	such that $x\in V_i=V'_i\cap Y_i\subset Z\cap Y_i$.
	Then $V_1\cap V_2\subset Z\cap Y$
	is an open set of $Y$ containing  $x$.
	\item  $x\in Y_1$ but $x\notin Y_2$,
	pick $V_1$ as above,
	then $V_1\setminus (V_1\cap Y_2)\subset Z\cap Y$
	is an open set of $Y$ containing  $x$.
	\end{enumerate}
	If $Y$ is irreducible, by the lemma above
	$Z\cap Y$ contains a nonempty open subset $V$ of $Y$.
	Then either $x\in V$,
	or  $x\notin V$
	and there exists  $V'\subset Z\cap (Y\setminus V)$
	which is open in  $Y\setminus V$ and contains $x$. 
	Then $V'\cup V\subset Z\cap Y$
	is an open set of $Y$ containing  $x$.
\end{proof}
	
According to the two lemmas above,
a subset $Z$ of a Noetherian space $X$ is open if and only 
$Z\cap Y$ is either empty or contains a nonempty open subset 
of  $Y$ for any closed irreducible  $Y\subset X$.
\begin{prop}[Topological Nagata criterion]\label{prop:Nagata}
	Let $A$ be a Noetherian ring
	and $U$ be a subset of $\Spec(A)$.
	Then $U$ is open if and only if
	$U$ is closed under generization 
	and $U$ contains a non-empty open subset of 
	$V(\fp)$ when  $\fp\in U$.
\end{prop}


\begin{thm}[Chevalley theorem]
	Let $f\colon X\to Y$ be a morphism of finite type
	betwen Noetherian schemes.
	Then $f(Z)$ is a constructible subset of  $Y$
	if $Z$ is a constructible subset of  $X$.
\end{thm}
\begin{proof}
	The proof is eventually reduced to the following 
	situation:
	let $A\hookrightarrow B$ be an injective ring homomorphism,
	where $A,B$ are integral domains
	and $B$ is of finite type over  $A$,
	show that the image of $\Spec(B)\to \Spec(A)$ 
	contanis an open subset.

	Let $K$ be the fractional field of  $A$,
	by Noetherian normalization,
	there eixts  $T_1,\cdots,T_n\in B\otimes_AK$
	such that $B\otimes_AK$
	is integral over  $K[T_1,\cdots,T_n]$.
	Then there exists $g\in A\setminus\{0\}$ 
	such that $T_i\in B\otimes_AA_g$
	for all  $i$ and  $B\otimes_AA_g$
	is integral over  $C=A_g[T_1,\cdots,T_n]$.
	Now, $\fp C$ is a prime of $C$ for $\fp\in D(g)$,
	and by integrality there exits $\wp\subset B$
	such that $\wp\cap A_g=\fp$.
	Therefore the image of  $\Spec(B)$
	contains the open subset  $D(g)$.
\end{proof}

\begin{proof}
	Let $K$ be the fractional ideal of  $A$
	and pick alg.independent  $T_1,\cdots,T_n\in B\otimes_AK$
	such that $B\otimes_AK$ is integral over
	$K[T_1,\cdots,T_n]$ (Noetherian normalization).
	Can find $g\in S=A\setminus 0$
	such that  $T_i=t_i/g, t_i\in B$
	and integral equations has coefficients in  $A_g$.
\end{proof}

\begin{prop}
	Let $f\colon X\to Y$ be a morphism of finite type
	between Noetherian schemes,
	$x\in X$, and  $y=f(x)$.
	Then $f$ is an open map if 
	if $f$ is quasi-flat.
\end{prop}
\begin{proof}
	Let $U\subset X$ be an open subset.
	Then $f(U)$ is open 
	since it is closed under generization
	by quasi-flatness and 
	constructible by Chevalley theorem.
\end{proof}

\begin{prop}
	Let $A$ be a Noetherian domain,
	$B$ be an $A$-algebra of finite type,
	and $M$ a finite $B$-module.
	Then there exists $f\in A$
	such that  $M_f$ is free over $A_f$.
\end{prop}
\begin{proof}
	When $B=A$,
	pick $x_1,\cdots,x_n\in M$
	which forms a bais of
	$M\otimes_AK$ over  $K$,
	the fractional field of  $A$.
	Consider the induced sequence
	\[
		0\to N\to A^n\to M\to P\to 0.
	\]
	Then $N\otimes_AK=0=P\otimes_AK$
	(recall that $K$ is flat over  $A$),
	thus there exists $f\in A$ such that $N_f=0=P_f$
	and consequently $M_f$ is free over  $A_f$.

	It then suffices to show that 
	the statements are true for $B[T]$ when
	they are true for  $B$.
	Let $M$ be a finite  $B[T]$-module
	and $(x_1,\cdots,x_n)$ be a set of generaters.
	Let $M_1$ be the $B$-submodule generated by them,
	and in general define 
	$M_{n+1}=M_n+TM_n=M_1+TM_1+\cdots+T^nM_1$ for $n\geq 1$.
	Observe that the kernels of the surjections
	\[
		M_1\xrightarrow{T^n} M_{n+1}/M_n
	\]
	is an increasing sequence that eventually terminates
	by the Noetherian hypothesis.
	Therefore $\{M_{n+1}/M_n\}$ is a finite sequence
	of $B$-modules. 
	By induction, there eixts  $f\in A$
	such that  all  $(M_{n+1}/M_n)_f$ are free over $A_f$,
	and therfore  $M_f$ is free over  $A_f$.
\end{proof}

\begin{thm}
	Let $A$ be a Noetherian ring,
	$B$ be an  $A$-algebra of finite type,
	and $M$ be a finite $B$-module,
	then  
	$U=\{\wp\in \Spec(B)\mid M_\wp \text{ is flat over }A\}$ 
	is a open subset in $\Spec(B)$.
\end{thm}
\begin{proof}
	Clearly $U$ is closed under generization.
	On the other hand,
	to verify the topological Nagata criterion, suppose
	$\wp\in U$ and  $\fp=\wp\cap A$.
	By \ref{thm:criterion},
	$M_Q$ is flat over  $A$
	for $Q\in V(\wp)$ if and only if 
	$M_Q/\fp M_Q$ is flat over $A/\fp$
	and $\Tor_1(M_Q,A/\fp)=0$.
	In particular 
	$\Tor_1(M_\wp,A/\fp)=\Tor_1(M,A/\fp)\otimes_BB_\wp=0$.
	Since $\Tor_1(M,A/\fp)$ is a finite $B$-module,
	there exists then a neighborhood of $V(\wp)$
	on which $\Tor_1(M_Q,A/\fp)=0$.
	And by generic flatness, there exists  $f\notin\fp$
	such that  $M_f/\fp M_f$ is  $(A/\fp)_f$ free,
	then  $M_Q/\fp M_Q$ is flat if $Q\in V(\wp)\cap D(f)$.
\end{proof}

\subsection{descent}

\begin{defn}
	A morphism $Y\to X$
	is a strict epimorphism if the sequence below is exact.
	 \[
		 \Hom(X,Z)\to \Hom(Y,Z)
		 \rightrightarrows_{p_2}^{p_1}
		 \Hom(Y\times_XY,Z)
	\]
\end{defn}

\begin{prop}
	If $f\colon A\to B$ is faithfully-flat
	and $M$ is an  $A$-module,
	the folowing sequence is exact.
	\[
		0\to M\xrightarrow{f}
		M\otimes_AB\xrightarrow{d_1}
		M\otimes_AB\otimes_AB\xrightarrow{d_2}\cdots
		\xrightarrow{d_{r-1}} 
		M\otimes_AB^{\otimes r}\xrightarrow{d_r}\cdots
	\]
	where 
	$d_r=\sum_{i=0}^r (-1)^ie_i$ and
	$e_i(b_0\otimes\cdots\otimes b_{r-1})=
	b_0\otimes\cdots\otimes b_{i-1}\otimes 1\otimes b_i\otimes\cdots\otimes b_{r-1}$.
\end{prop}
\begin{proof}
	If there exists a sction $g\colon B\to A$
	such that  $g\circ f=I_A$, then
	 \[
		 k_r\colon B^{\otimes r+1}\to B^{\otimes r}\quad
		 k_r(b_0\otimes\cdots\otimes b_{r})
		 =g(b_0)b_1\otimes\cdots\otimes b_{r}
	\]
	defines a contracting homotopy
	satisfying $k_{r}d_{r}+d_{r+1}k_{r+1}=1$.
	The same sequence $\otimes_AB$
	is exact since  $B\to B\otimes_AB$ 
	admits sections.
	Thus the original sequence is exact 
	since $A\to B$ is faithfully flat.
\end{proof}

\begin{prop}
	A faithfully flat morphism
	$f\colon X\to Y$
	of finite-type is 
	a stric epimorphism.
\end{prop}
\begin{prop}
	Let $f\colon X\to Y$ be faithfully flat and quasi-compact.
	To give a quasi-coherent $\oo_Y$-module  $M$
	is the same as to give a quasi-coherent  $\oo_X$-module
	 $M'$ and an isomorphism  $\phi\colon p_1^*M'\to p_2^*M'$ 
	 satisfying
	 \[
		 p_{31}^*(\phi)=
		 p_{32}^*(\phi)
		 p_{21}^*(\phi)
	 \]
	 where $p_{ji}(x_1,x_2,x_3)=(x_j,x_i)$ for $j>i$.
\end{prop}

\section{Etale morphisms}

\begin{defn}
	Let $k$ be a ring, $A$ be a $k$-algebra,
	and $M$ be an $A$-module.
	Define
	\[
		\Der_k(A,M)=
		\{D\in\Hom_k(A,M)\mid 
		D(fg)=fD(g)+gD(f)\text{ for }f,g\in A\}
	\]
	Then there eixits an  $A$-module  $\Omega^1_{A/k}$
	such that $\Hom_A(\Omega^1_{A/k},M)\cong \Der_k(A,M)$.
\end{defn}
\begin{itemize}
	\item let $\varphi\colon A\to B$ be a 
		$k$-algebra homomorphism, then
		\begin{align*}
		&0\to \Der_A(B,M)\to \Der_k(B,M)\to \Der_A(B,M)\\
		\Longleftrightarrow \quad
		&\Omega^1_{A/k}\otimes_AB\to \Omega^1_{B/k}
		\to \Omega^1_{B/A}\to 0
		\end{align*}
	\item let $A$ be a $k$-algebra and  $B=A/I$, then
		\begin{align*}
	&0\to \Der_k(B,M)\to \Der_k(A,M)\to\Hom_B(I/I^2,M)\\
		 \Longleftrightarrow\quad
	&I/I^2\to \Omega^1_{A/k}\otimes_AB\to \Omega^1_{B/k}\to 0
		\end{align*}
	\item Let $B_1,B_2$ be  $k$-algebras and 
		 $A=B_1\times B_2$, then
		 $\Omega_{A/k}\cong
		 \Omega_{B_1/k}\oplus\Omega_{B_2/k}$.
	\item Let $A$ be a $k$-algebra and
	$k\to k'$ be a ring homomorphism then
	\[
		\begin{tikzcd}
			A'
		\arrow[dr, phantom, "\ulcorner", very near start]
		\arrow[d]\arrow[r]& k'\arrow[d]\\
		A\arrow[r]& k
		\end{tikzcd}\Longrightarrow\quad
	\Omega_{A'/k'}\cong
	\Omega_{A/k}\otimes_AA'\cong\Omega_{A/k}\otimes_kk'.
	\]
	\item Let $A$ be a $k$-algebra with $\varphi\colon k\to A$
	$S\subset k$ and $T\subset A$ be multiplicative subsets
	such that $\varphi(S)\subset T$,
	then $\Omega_{T^{-1}A/S^{-1}k}\cong T^{-1}\Omega_{A/k}$.
	\item Let $B_1,B_2$ be $k$-algebras and 
	$A=B_1\otimes_kB_2$, then
	$ \Omega^1_{B_i/k}\otimes_{B_i}A\to 
	\Omega^1_{A/k}\to \Omega^1_{A/B_i} \to0$ and 
	$\Omega^1_{A/B_1}=\Omega^1_{B_{2}/k}\otimes_{B_{2}}A$,
	$\Omega^1_{A/B_2}=\Omega^1_{B_{1}/k}\otimes_{B_{1}}A$,
	implies that
	\[
	\Omega_{A/k}\cong \Omega_{B_1/k}\otimes_{B_1}A\oplus
	\Omega_{B_2/k}\otimes_{B_2}A.
	\]
\end{itemize}

\begin{rem}
	In the language of schemes,
	let $X$ be an $S$-scheme,
	then there exists a quasi-coherent sheaf
	$\Omega_{X/S}$ and an exterior differntial
	$d\colon \oo_X\to \Omega_{X/S}$.
\begin{itemize}
	\item Let $f\colon X\to Y$
	be a morphism between $S$-schemes, then
	$f^*\Omega^1_{Y/S}\to\Omega^1_{X/S}\to\Omega^1_{X/Y}\to0$
	\item Let $i\colon X\hookrightarrow Y$ be an immersion
	of  $S$-schemes, then
	$J/J^2\xrightarrow{\delta}i^*\Omega^1_{Y/S}
	\to\Omega^1_{X/S}\to 0$,
	where $J$ is the sheaf of ideals
	defining  $X$ and
	the $\oo_X$-module $J/J^2$ is called
	the conormal sheaf of $X$ in  $Y$.
	In fact, $\Omega_{X/S}$ is the conormal sheaf of
	$\iota\colon X\to X\times_SX$.
	\item Let $X, Y$ be  $S$-schemes, then
	$\Omega^1_{X/S}\oplus \Omega^1_{Y/S}
	\cong \Omega^1_{X\sqcup Y/S}$.
	\item Let $X$ be an $S$-scheme and
	$S'\to S$ be a morphism between schemes,
	\[
		\begin{tikzcd}
			X'
		\arrow[dr, phantom, "\ulcorner", very near start]
		\arrow[d,"f",swap]\arrow[r]& S'\arrow[d]\\
		X\arrow[r]& S
		\end{tikzcd}\Longrightarrow\quad
		f^*\Omega^1_{X/S}\cong \Omega^1_{X'/S'}
	\]
	\item Let $X, Y$ be  $S$-schemes, then
	 $pr_1^*\Omega^1_{X/S}\oplus pr_2^*\Omega^1_{Y/S}
	 \cong \Omega^1_{X\times_SY/S}$.
\end{itemize}
\end{rem}

In the rest of the section,
schemes are assumed locally Noetherian
and morphisms between schemes are assumed
locally of finite type.

\subsection{quasi-finite}
\begin{defn}
	Let $\varphi\colon A\to B$ be a local ring map 
	and denote by $k$ the residue field of $A$.
	Then $\varphi$ is quasi-finite
	if  $\dim_{k}(B\otimes_Ak)<\infty$.
	The followings are equivalent.
	\begin{enumerate}[label=(\alph*)]
	\item $\varphi\colon A\to B$ is quasi-finite,
		so $B\otimes_Ak$ is a finite over $k$.
	\item $B\otimes_Ak$ is Artinian.
	\item $\Spec(B\otimes_Ak)$ is finite and discrete.
	\item $\Spec(B\otimes_Ak)$ is discrete.
	\item $\fm_B^r\subset \fm_AB$ for some  $r\geq 0$
		and  $B/\fm_B$ is a finite extension of $k$.
	\end{enumerate}
	A morphism $f\colon X\to Y$ between schemes
	is quasi-finite if
	$\oo_{f(x)}\to\oo_x$ is quasi-finite for each $x\in X$.
\begin{itemize}
	\item An immersion is quasi-finite.
	\item Quasi-finiteness is closed under
		composition and base-change.
\end{itemize}
\end{defn}
\begin{lem}
	Let $\varphi\colon A\to B$ be a local ring map
	and $\hat{A}, \hat{B}$ be the completions
	with respect to $\fm_A$ and  $\fm_B$.
	Then $B$ is quasi-finite over $A$
	if and only if
	$\hat{B}$ is finite over $\hat{A}$.
\end{lem}
\begin{proof}
	Let $k$ be the residue field of  $A$.
	If $B$ is quasi-finite over  $A$,
	lift a $k$-basis of  $B\otimes_Ak$ to
	$\hat{A}^{\oplus n}\to \hat{B}$,
	which is surjective since 
	$\hat{B}/\hat{\fm}_A\hat{B} =\hat{B}/\fm_A\hat{B}=
	(B/\fm_AB)^\wedge=B/\fm_AB=B\otimes_Ak$.

	Conversely, 
	$\hat{\fm}_B^r\subset \fm_A\hat{B}$
	for some $r\geq 0$ if $\hat{B}$ is finite over $\hat{A}$.
	This implies that $\fm_B^r\subset \fm_AB$
	since $\hat{\fm}_B^r\to \hat{B}/\fm_A\hat{B}$ is 
	the zero map and $\hat{B}$ is faithfully flat over $B$.
\end{proof}


\subsection{unramified}

\begin{defn}
	Let $\varphi\colon A\to B$ be a local ring map
	and denote by $k$ the residue field of $A$.
	Then  $\varphi$ is unramified if 
	$\fm_B=\fm_AB$ and  $B/\fm_B$ is a 
	finite separable over $k$.
	In particular $\varphi$ is quasi-finite.
\end{defn}
\begin{lem}\label{lem:unramified_completion}
	With notations as above,
	$B$ is unramified over  $A$
	if and only if 
	$\hat{B}$ is unramified over $\hat{A}$.
	Furthermore, suppose $\varphi$ is unramified
	and  $B/\fm_B=k$,
	then $\hat{\varphi}$ is surjective.
\end{lem}
\begin{lem}
	Let $k$ be a field and 
	$K$ be a finite  $k$-algebra.
	Then $K$ is said to be separable 
	if  $\rad(K\otimes_k\bar{k})=0$, or equivalently
	$K\otimes_k\bar{k}$ is a finite product of $\bar{k}$,
	which extends the concept of separable field extensions.
	Then the followings are equivalent.
	\begin{enumerate}[label=(\alph*)]
		\item $K$ is separable.
		\item  $K$ is a finite product of finite separable
			field extensions over  $k$.
		\item  $\Omega_{K/k}=0$.
	\end{enumerate}
\end{lem}
\begin{proof}
	If $K$ is separable, then $K\otimes_k\bar{k}$ is reduced.
	For any $x\in K$ consider then
	the subfield generated over $k$,
	which is isomorphic to some $k[X]/f(X)$.
	then $f(X)$ is a separable polynomial 
	since $\bar{k}[X]/f(X)$ is reduced.

	If $K/k$ is a separable field extension
	and  $D\in Der_K(L,M)$,
	for any  $x\in K$ let $f(X)$ be the minimal polynomial 
	of which,
	then  $0=D(f(x))=f'(x)D(x)$
	and thus $D(x)=0$ since $f'(x)\neq 0$.

	If $\Omega_{K/k}=0$, may assume $k=\bar{k}$ 
	and $K$ is local with residue field  $k$.
	Since $K\otimes_kK$ is then local 
	and  $\Omega_{K/k}\cong I/I^2$
	for $I=\ker(K\otimes_kK\to K)$,
	$\Omega_{K/k}=0$ implies $I=0$,
	therefore $\dim_k(K)=1$  and $K=k$.
\end{proof}

\begin{defn}
	Let  $f\colon X\to Y$ a morphism between scheme,
	then $f$ is unramified at  $x$
	if $\oo_x$ is unramified over $\oo_y$ for $y=f(x)$.
	By the previous proposition 
	this is equivalent to that 
	$\Omega^1_{X/Y}$ is zero at $x$.
\begin{itemize}
	\item An immersion is unramified.
	\item Unramifiedness is closed under composition
		and base-change.
	\item If $g\circ f$ is unramified,
		then $f$ is unramified.
\end{itemize}
\end{defn}

\subsection{\'{e}tale}

\begin{defn}
	A local ring map $\varphi\colon A\to B$ 
	is \'{e}tale if  $\varphi$ is both flat and unramified.
	A morphism $f\colon X\to Y$ between schemes
	is \'{e}tale at $x\in X$ 
	if $f$ is both flat and unramified at $x\in X$.
	Note that this implies that $f$ is \'{e}tale at a 
	neighborhood of $x$ since both this is true
	for both being unramified and flat at $x$.
	\begin{itemize}
		\item An open immersion is \'{e}tale.
		\item \'{E}taleness is closed under 
			composition and base-change.
		\item If $g\circ f$ is \'{e}tale and 
			$g$ is unramified, then  $f$ is \'{e}tale.
	\end{itemize}
	The last property follows from the diagram below
	and that $\Delta_{Y/S}$ is an open immersion.
	\[
	\begin{tikzcd}
		Y\arrow[r,"\Delta_{Y/S}"]& Y\times_SY&\\
		X\arrow[ur, phantom, "\llcorner", very near start]
		\arrow[u,"f"]\arrow[r]& 
		X\times_SY\arrow[u,"f\times\id_Y",swap]
		\arrow[dr, phantom, "\ulcorner", very near start]
		\arrow[d]\arrow[r]&Y\arrow[d,"g"]\\
		&X\arrow[r,"g\circ f"]&S
	\end{tikzcd}
	\]
\end{defn}

\begin{rem}
	By Proposition \ref{prop:flat_completion}
	and Lemma \ref{lem:unramified_completion},
	$B$ is \'{e}tale over $A$ if and only if
	$\hat{B}$ is \'{e}tale over $\hat{A}$.
	Consequently 
	$\hat{\varphi}\colon \hat{A}\to\hat{B}$
	is finite and injective,
	and even an isomorphism
	when the residue fields agree.
\end{rem}

\begin{prop}
	If $f:X\to Y$ is an \'{e}tale morphism
	between  $S$-schemes 
	then $f^*\Omega^1_{Y/S}\cong \Omega^1_{X/S}$.
\end{prop}
\begin{proof}
	Consider the diagram below.
	Since $h$ is flat
	the conormal sheaf of  $g'$ is
	the pull-back by $h'$ of the conormal sheaf of  $g$.
	Then the proposition follows from that 
	$\Delta_{X/Y}$ is an open immersion.
	\[
		\begin{tikzcd}
			X\arrow[r,"\Delta_{X/Y}"]
			\arrow[dr,"f"] &
			X\times_YX
			\arrow[dr, phantom, "\ulcorner", 
			very near start]
			\arrow[r,"g'"]
			\arrow[d,"h'"] &
			X\times_SX \arrow[d,"h"]\\
		   & Y\arrow[r,"\Delta_{Y/S}=g"] &
		   Y\times_SY
		\end{tikzcd}
	\]
\end{proof}


\begin{prop}[fiberwise criterion]
	Let $f\colon X\to Y$ be a morphism
	between flat $S$-schemes
	and suppose $x\in X$ is mapped to  $s\in S$.
	Then  $f$ is  flat/\'{e}tale at $x$
	if and only if $f\otimes_Sk(s)$
	is flat/\'{e}tale at $x$.
\end{prop}
\begin{proof}
	The flatness part follows from the fiberwise criterion.
	Then notice that it follows automatically from the 
	definition that similar statement holds for 
	being unramified.
\end{proof}

\begin{rem}[Jacobian criterion]
	If $B=A[X_1,\cdots,X_n]/(f_1,\cdots,f_n)$,
	then $B$ is \'{e}tale if 
	the Jacobian $(\frac{\partial f_i}{\partial X_j})$ 
	is invertible in $B$.
	For unramifiedness look at the exact sequence,
	for flatness may assume $A=k$ is a field,
	then show that $B$ is regular,
	so  $f_i$ is regular sequence,
	so  $B$ is flat.
\end{rem}

\subsection{radicial}
\begin{defn}
	A morphism $f\colon X\to Y$
	betwen schemes is radicial if it is injective and
	$k(x)/k(f(x))$ is purely inseparable for all  $x\in X$.
	Thus
	$f$ is an open immersion if and only if
	$f$ is both  \'{e}tale and radicial.
\end{defn}
\begin{prop}
	The following conditions 
	on a morphism $f\colon X\to Y$
	between schemes are equivalent.
	 \begin{enumerate}[label=(\roman*)]
		\item $f$ is radicial.
		\item $X(K)\to Y(K)$ is injective 
			for any field $K$.
		\item $f_{Y'}\colon X\times_YY'\to Y'$ is injective
			for any base change
			$Y'\to Y$.
		\item $f_K\colon X\times_YK\to \Spec(K)$ 
			is injective for any field $K$ and
			$\Spec(K)\to Y$.
	\end{enumerate}
\end{prop}
\begin{proof}
	Suppose $f$ is radical
	and  $u_1,u_2\in X(K)$ are such that
	for  $f\circ u_1=f\circ u_2$.
	It follows from the injectivity of $f$
	that  $u_i$ are mapped to the same point  $x\in X$ 
	and they corresponds to 
	$k(f(x))$-algebra homomorphisms $k(x)\to K$.
	Thus $u_1=u_2$ since $k(x)/k(y)$ is purely inseparable.
	Conversely if
	$x_1,x_2\in X$ are such that  $f(x_1)=y=f(x_2)$,
	then there exists an extension  $K/f(y)$
	containing both  $k(x_i)$,
	thus  $(ii)$ implies that  $f$ is injective 
	and radicial.
	Now $(ii)\Longrightarrow (iii)\Longrightarrow(iv)$ since 
	\[
		X\times_YY'(K)=X(K)\times_{Y(K)}Y'(K),\quad
		Y'(K)=Y(K)\times_{Y(K)}Y'(K).
	\]
	At last, suppose $(iv)$ holds 
	and consider the diagram below.
	\[
		\begin{tikzcd}
			X\times_YK
			\arrow[r,"f'"]
			\arrow[d]
			& \Spec(K)
			\arrow[dl,shift left,"u_1"]
			\arrow[dl,shift right,"u_2",swap]
			\arrow[d]\\
			X \arrow[r,"f",swap]& Y
		\end{tikzcd}
	\]
	Since $u_i$ induces sections  $u_i'$ of  $f'$,
	it follows from the injectivity of  $f'$
	that  $X\times_YK$ is a single point with 
	the residue field  $K$.
	Thus  $u_1'=u_2'$ and  $u_1=u_2$.
\end{proof}

\begin{itemize}
	\item An immersion is radicial.
	\item Being radicial is closed under composition
		and base-change.
	\item If $g\circ f$ is radicial, then $f$ is radicial.
\end{itemize}

\subsection{covers}
\begin{defn}
	A morphism $f\colon X\to Y$ between schemes
	is a cover if $f$ is both finite and surjective.
	Then the branch locus of $X$ over  $Y$
	is the set of points where $f$ is ramified,
	which is the closed subsubscheme
	defined by the annihilator of $\Omega^1_{X/Y}$.
\end{defn}

If $B$ is an  $A$-algebra generated by a single element,
consider the exact sequence
\[
	 I/I^2\to \Omega^1_{A[T]/A}\otimes_AB
	 \to \Omega^1_{B/A}\to 0
\]
for $I=\ker(A[T]\to B)$.
Thus $\Omega^1_{A[T]/A}\otimes_AB$ 
is free over $B$ generated by $dT$,
$\Omega^1_{B/A}$ is isomorphic to $B/d(I)B$,
where $d(I)=\{\frac{d}{dT}Q(T)\mid Q(T)\in I\}$,
so $d(I)B$ is the different.
If $I=(P(T))$, then
$B/A$ is unramified if $(P,P')=A[T]$.
Furthermore, $B/A$ is free and hence \'{e}tale
if the leading coefficient of $P(T)$ is a unit in $A$.

\subsection{smooth}

\begin{defn}
	$f\colon X\to Y$
	between locally Noetherian schemes.
	Then  $X$ is smooth over  $Y$
	at  $x\in X$ if there is a neighborhood
	 $U$ of  $x$ and
	  \[
	 	\begin{tikzcd}
			U\arrow[r]\arrow[dr,"f"]
			& \A^n\times Y\arrow[d]\\
			& Y
	 	\end{tikzcd}
	 \]
	 where $g$ is \'{e}tale and  $p$ is 
	 a projection.
\end{defn}

\begin{thm}
	$f\colon X\to Y$
	locally of finite type
	between locally Noetherian schemes.
	 $f$ is smooth at  $x$ iff
	  \begin{enumerate}[label=(\alph*)]
	 	\item $f$ is flat at  $x$
		\item $f^{-1}(y)$
			is smooth over  $k(y)$
			at  $x$.
	 \end{enumerate}
\end{thm}

Consequently,
$f\colon X\to Y$ an  $S$-morphism
between  $X,Y$ locally of finite type over  $S$.
Let  $x\in X$ over  $s\in S$
and suppose  $Y$ is flat over  $S$,
then  $f$ is smooth at  $x$ iff
 \begin{enumerate}[label=(\alph*)]
	\item $X$ is flat over  $S$ at  $x$
	\item  $f_s\colon X_s\to Y_s$
		is smooth at  $x$.
\end{enumerate}

\section{misc}

A property $P$ of ring maps is local if 
the followings holds.
\begin{enumerate}[label=(\alph*)]
	 \item for  any $R\to A$ and  $f\in R$,
	 $P(R\to A \Longrightarrow P(R_f\to A_f)$.
	 \item    any  $f\in R, a\in A$ and  $R_f\to A$,
	 $P(R_f\to A)\Longrightarrow P(R\to A_a)$.
	 item for any  $R\to A$ and  $a_i\in A$ 
	 such that  $(a_1,\cdots,a_n)=A$,
		$P(R\to A_{a_i})\Longrightarrow P(R\to A)$.
\end{enumerate}
A morphism $f\colon X\to S$ between schemes 
is locally of type $P$ if for any  $x\in X$,
there exists an affine open subset  $x\in U$ of  $X$
and an open affine subset $V$ of $Y$ with  $f(U)\subset V$
such that $P(O_S(V)\to O_X(U))$.
\begin{lem}
	If $f\colon X\to S$ is locally of type  $P$
	for a property  $P$ that is local,
	then $P(\oo_S(V)\to \oo_X(U))$ holds
	for any open affine subsets 
	$U\subset X$ and  $V\subset S$
	with  $f(U)\subset V$.
\end{lem}



%\bibliography style{amsalpha}
%\bibliography biblio}
\end{document}
